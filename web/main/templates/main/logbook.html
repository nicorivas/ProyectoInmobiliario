{% load custom_tags %}
{% load mathfilters %}
  <div class="row mb-2">
    <div class="col-8">
      <a href="{{appraisal.url}}">
        <p style="display:inline-block;vertical-align:-webkit-baseline-middle;margin-bottom:0em;">
          {{appraisal.real_estates.first.address}}
          {% if appraisal.real_estates.all|length > 1 %}
          (+{{appraisal.real_estates.all|length|sub:1}})
          {% endif %}
        </p>
      </a>
    </div>
    <div class="col-4" style="text-align:right;">
      {% if appraisal.orderFile %}
      <div class="btn btn-light">
        <a href="{{appraisal.orderFile.url}}">
          <div style="vertical-align:middle;display:inline-block;font-size:0.8em;">Solicitud</div>
          <div style="vertical-align:middle;display:inline-block;font-size:1.2em;" class="material-icons" style="font-size: 1em;">save_alt</div>
        </a>
      </div>
      {% endif %}
      {% if appraisal.orderFile %}
      <div class="btn btn-light">
        <a href="{{appraisal.orderFile.url}}">
          <div style="vertical-align:middle;display:inline-block;font-size:0.8em;">Informe</div>
          <div style="vertical-align:middle;display:inline-block;font-size:1.2em;" class="material-icons" style="font-size: 1em;">save_alt</div>
        </a>
      </div>
      {% endif %}
    </div>
  </div>
  <div class="row">
    <div class="col-9">
      <p style="font-size:0.9em;margin-bottom:0em;">
        {{appraisal.solicitanteVerbose}} ({{appraisal.solicitanteCodigo}})
         | <span style='font-weight: 800; color:#000;'>{{appraisal.get_tipoTasacion_display}}</span>
      </p> 
    </div>
    <div class="col-3" style="text-align:right;">

    </div>
  </div>

  <hr/>

  <!--<h6> Contactos </h6>-->
  <form id="logbook_form">
    {% csrf_token %}
    <input name="appraisal_id" value="{{appraisal.id}}" style="width:240px;" hidden>
    <div class="row mt-2" style="font-size:0.8em;">
      <div class="col-2">
        <p class="text-right"><b>Pedido</b></p>
      </div>
      <div class="col-3" style="padding:0em;">
        <p class="text-left">{{appraisal.timeCreated|date:"d/m/Y G:i"}}</p>
      </div>
      <div class="col-2">
        <p class="text-right"><b>Tasador</b></p>
      </div>
      <div class="col-4">
        {% if appraisal.tasadorUser %}
        <p>
        {{ appraisal.tasadorUser.first_name }} {{ appraisal.tasadorUser.last_name.strip }}
        </p>
        {% else %}
        <p>
        <em>No asignado</em>
        </p>
        {% endif %}
      </div>
    </div>
    <div class="row" style="font-size:0.8em;">
      <div class="col-2">
        <p class="text-right"><b>Entrega</b></p>
      </div>
      <div class="col-3" style="padding:0em;">
        <p class="text-left">{{appraisal.timeDue|date:"d/m/Y G:i"}}</p>
      </div>
      <div class="col-2">
        <p class="text-right"><b>Visador</b></p>
      </div>
      <div class="col-4">
        {% if appraisal.visadorUser %}
        <p>
        {{ appraisal.visadorUser.first_name }} {{ appraisal.visadorUser.last_name.strip }}
        </p>
        {% else %}
        <p>
        <em>No asignado</em>
        </p>
        {% endif %}
      </div>
      <div class="col-2" style="text-align:right;">
        <span style="vertical-align:-webkit-baseline-middle"><b>Ejecutivo/a</b></span>
      </div>
      <div class="col-10" style="padding:0em;">
        <p>
          <input name="solicitanteEjecutivo" class="edit_contact" value="{{appraisal.solicitanteEjecutivo|default_if_none:""}}" placeholder="Nombre" style="width:240px" {{perms.appraisal.can_validate_contacts|yesno:",readonly"}}>
          <input name="solicitanteEjecutivoEmail" class="edit_contact" value="{{appraisal.solicitanteEjecutivoEmail|default_if_none:""}}" placeholder="Email" style="width:180px" {{perms.appraisal.can_validate_contacts|yesno:",readonly"}}>
          <input name="solicitanteEjecutivoTelefono" class="edit_contact" value="{{appraisal.solicitanteEjecutivoTelefono|default_if_none:""}}" placeholder="Teléfono" style="width:100px" {{perms.appraisal.can_validate_contacts|yesno:",readonly"}}>
        </p>
      </div>
      <div class="col-2" style="text-align:right;">
        <span style="vertical-align:-webkit-baseline-middle"><b>Cliente</b></span>
      </div>
      <div class="col-8" style="padding:0em;">
        <p>
          <input name="cliente" class="edit_contact edit_contact_cliente" value="{{appraisal.cliente|default_if_none:""}}" placeholder="Nombre" style="width:240px;" {{appraisal.clienteValidado|yesno:"readonly,"}} {{perms.appraisal.can_validate_contacts|yesno:",readonly"}}>
          <input name="clienteEmail" class="edit_contact edit_contact_cliente" value="{{appraisal.clienteEmail|default_if_none:""}}" placeholder="Email" style="width:180px" {{appraisal.clienteValidado|yesno:"readonly,"}} {{perms.appraisal.can_validate_contacts|yesno:",readonly"}}>
          <input name="clienteTelefono" class="edit_contact edit_contact_cliente" value="{{appraisal.clienteTelefono|default_if_none:""}}" placeholder="Teléfono" style="width:100px" {{appraisal.clienteValidado|yesno:"readonly,"}} {{perms.appraisal.can_validate_contacts|yesno:",readonly"}}>
        </p>
      </div>
      <div class="col-2">
        {% if perms.appraisal.can_validate_contacts %}
        <div class="form-check" style="padding-top:4px">
          <input type="checkbox" class="form-check-input btn_validate" data-type="1" id="exampleCheck1" {{appraisal.clienteValidado|yesno:"checked,"}}>
          <label class="form-check-label" for="exampleCheck1">Validado</label>
        </div>
        {% endif %}
      </div>
      <div class="col-2" style="text-align:right;">
        <span style="vertical-align:-webkit-baseline-middle"><b>Contacto</b></span>
      </div>
      <div class="col-8" style="padding:0em;">
        <p>
          <input name="contacto" class="edit_contact edit_contact_contacto" value="{{appraisal.contacto|default_if_none:""}}" placeholder="Nombre" style="width:240px" {{appraisal.contactoValidado|yesno:"readonly,"}} {{perms.appraisal.can_validate_contacts|yesno:",readonly"}}>
          <input name="contactoEmail" class="edit_contact edit_contact_contacto" value="{{appraisal.contactoEmail|default_if_none:""}}" placeholder="Email" style="width:180px" {{appraisal.contactoValidado|yesno:"readonly,"}} {{perms.appraisal.can_validate_contacts|yesno:",readonly"}}>
          <input name="contactoTelefono" class="edit_contact edit_contact_contacto" value="{{appraisal.contactoTelefono|default_if_none:""}}" placeholder="Teléfono" style="width:100px" {{appraisal.contactoValidado|yesno:"readonly,"}} {{perms.appraisal.can_validate_contacts|yesno:",readonly"}}>
        </p>
      </div>
      <div class="col-2">
        {% if perms.appraisal.can_validate_contacts %}
        <div class="form-check" style="padding-top:4px">
          <input type="checkbox" class="form-check-input btn_validate" data-type="2" id="exampleCheck1" {{appraisal.contactoValidado|yesno:"checked,"}}>
          <label class="form-check-label" for="exampleCheck1">Validado</label>
        </div>
        {% endif %}
      </div>
      <div class="col-2" style="text-align:right;">
        <span style="vertical-align:-webkit-baseline-middle"><b>Propietario/a</b></span>
      </div>
      <div class="col-10" style="padding:0em;">
        <p>
          <input name="propietario" class="edit_contact" value="{{appraisal.propietario|default_if_none:""}}" placeholder="Nombre" style="width:240px" {{perms.appraisal.can_validate_contacts|yesno:",readonly"}}>
          <input name="propietarioEmail" class="edit_contact" value="{{appraisal.propietarioEmail|default_if_none:""}}" placeholder="Email" style="width:180px" {{perms.appraisal.can_validate_contacts|yesno:",readonly"}}>
          <input name="propietarioTelefono" class="edit_contact" value="{{appraisal.propietarioTelefono|default_if_none:""}}" placeholder="Teléfono" style="width:100px" {{perms.appraisal.can_validate_contacts|yesno:",readonly"}}>
        </p>
      </div>
    </div>
  </form>

  <hr/>

  <div class="row">
    <div class="col-12">

      <form id="form_comment" data-comment-url="{% url 'ajax_comment_url' %}">
        {% csrf_token %}

        <input id="in_appraisal_id" name="appraisal_id" type="hidden" value=-1>
        <div class="row">
          <div class="col-6">
            <div class="form-group" id="div_event">
              <small>{{ form_comment.event.label_tag}}</small>
              {{ form_comment.event }}
            </div>
          </div>
          <div class="col-6">
            <div class="form-group" id="div_datetime" style="display:none;">
              <small>{{ form_comment.datetime.label_tag }}</small>
              <div class="input-group date" id="datetimepicker1" data-target-input="nearest">
                {{ form_comment.datetime }}
                <div class="input-group-append" data-target="#datetimepicker1" data-toggle="datetimepicker">
                  <div class="input-group-text"><i class="fa fa-calendar"></i></div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="alert alert-warning" id="div_warning_incidencia" style="display:none;padding:0.2em 1em 0.2em 1em;">
          <small>La tasación se marcará en conflicto</small>
        </div>
        <div class="alert alert-warning" id="div_warning_entregada" style="display:none;padding:0.2em 1em 0.2em 1em;">
          <small>La tasación se marcará como finalizada</small>
        </div>
        <script type="text/javascript">
          $(function () {
            $('#datetimepicker1').datetimepicker({
              locale: 'es',
              icons: {
                time: "far fa-clock",
                date: "far fa-calendar-alt",
                up: "fas fa-arrow-up",
                down: "fas fa-arrow-down"
              }
            });
          });
        </script>
        <div class="form-group" id="div_comment">
          <small>{{ form_comment.text.label_tag }}</small>
          {{ form_comment.text }}
        </div>
        <div class="form-group row" id="div_comment_btn">
          <div class="col-12">
            <button type="button" class="btn btn-dark btn-sm btn-block" name="btn_comment" id="btn_comment">
              <span class="text">Registrar evento</span>
              <div class="ld ld-ring ld-spin" style="display:none;"></div>
            </button>
          </div>
        </div>
        <div class="form-group row" id="div_accept_reject" style="display:none;">
          <div class="col-6">
            <button type="button" class="btn btn-sm btn-dark btn-block btn_accept" value="{{appraisal.id}}" id="accept_{{appraisal.id}}">
              <!--<span id='icon'>thumb_up</span>-->
              Aceptar tasación
              <div class="ld ld-ring ld-spin" style="display:none;"></div>
            </button>
          </div>
          <div class="col-6">
            <button type="button" class="btn btn-dark btn-sm btn-block btn_reject" value="{{appraisal.id}}" id="reject_{{appraisal.id}}">
              <!--<span id='icon'>thumb_down</span>-->
              Declinar tasación
              <div class="ld ld-ring ld-spin" style="display:none;"></div>
            </button>
          </div>
        </div>
      </form>

      <hr/>

      <div id="loading" class="mb-3 col-lg-12" style="display:none;">
        <div class="row">
          <div class="col-5"></div>
          <div class="col-2">
            <div class="col loader"></div>
          </div>
          <div class="col-5"></div>
        </div>
      </div>

      <div id="historial">

        <ul id="comment_list" class="list-group">
          {% for comment in comments %}
            {% include 'main/comment.html' %}
          {% endfor %}
        </ul>

      </div>

    </div>
  </div>