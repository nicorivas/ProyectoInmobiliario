
{% load static %}

<script src="{% static "main/js/modal_assign_tasador.js" %}" type="text/javascript"></script>
<script src="{% static "main/js/modal_assign_visador.js" %}" type="text/javascript"></script>
<script>
  comment_class = {{comment_class|safe}}
</script>

{% load custom_tags %}

<div class="container" style="max-width:100%">

<!-- NOT ASSIGNED -->

{% if request.user|has_group:"asignador" or user.is_superuser %} 

<div class="card mb-1" id="div_not_assigned">
  <div class="card-body">
    <p class="card-title">Tasaciones por asignar</p>
    <div class="alert alert-primary mb-0" role="alert" id="div_alert_table_not_assigned" style="display:none;">
      No hay tasaciones por asignar
    </div>
    <table class="table table-sm table-borderless table-appraisals" id="table_not_assigned">
      {% include 'main/appraisals_not_assigned.html' %}
    </table>
  </div>
</div>

{% endif %}

<!-- NOT ACCEPTED -->

<div class="card mb-1" id="div_not_accepted">
  <div class="card-body">
    <p class="card-title">Tasaciones por aceptar</p>
    <div class="alert alert-primary mb-0" role="alert" id="div_alert_table_not_accepted" style="display:none;">
      No tiene tasaciones por aceptar
    </div>
    <table class="table table-sm table-borderless table-appraisals" id="table_not_accepted">
      {% include 'main/appraisals_not_accepted.html' %}      
    </table>
  </div>
</div>

<!-- IN APPRAISAL -->

<div class="card mb-1" id="div_in_appraisal">
  <div class="card-body">
    <p class="card-title">Tasaciones en proceso</p>
    <div class="alert alert-primary" role="alert" id="div_alert_table_in_appraisal" style="display: none;">
      No hay tasaciones en proceso
    </div>
    <table class="table table-sm table-borderless table-appraisals" id="table_in_appraisal">
      {% include 'main/appraisals_in_appraisal.html' %}
    </table>
  </div>
</div>

<!-- IN REVISION -->

<div class="card mb-1" id="div_in_revision">
  <div class="card-body">
    <p class="card-title">Tasaciones en visación</p>
    <div class="alert alert-primary" role="alert" id="div_alert_table_in_revision" style="display: none;">
      No hay tasaciones en visación
    </div>
    <table class="table table-sm table-borderless" id="table_in_revision" style="display:none;font-size:0.8em;">
      {% include 'main/appraisals_table_in_revision.html' %}
    </table>
  </div>
</div>

<!-- SENT -->

<div class="card mb-4" id="div_sent">
  <div class="card-body">
    <p class="card-title">Tasaciones enviadas</p>
    <div class="alert alert-primary" role="alert" id="div_alert_table_sent" style="display: none;">
      No hay tasaciones enviadas
    </div>
    <table class="table table-sm table-borderless" id="table_sent" style="display:none;font-size:0.8em;">
      {% include 'main/appraisals_table_sent.html' %}
    </table>
  </div>
</div>

{% include "main/modals.html" %}

</div>

<script src="{% static 'main/js/tools.js' %}" type="text/javascript"></script>

<script src="{% static 'main/js/search.js' %}" type="text/javascript"></script>

<script src="{% static 'main/js/logbook.js' %}" type="text/javascript"></script>

<script>

  function addRow(table_name, appraisal_id, html) {
    // Remove row from table. Takes into account if this is
    // the last row remaining, in that case it hides the whole
    // table and shows the no elements alert div.
    $("<tr class='"+table_name+"' id='tr_"+table_name+"-"+appraisal_id+"' style='display:none;'>"+html+"</tr>").appendTo($('#'+table_name+' tr:last')).slideDown()
    //$("#tr_"+table_name+"-"+appraisal_id).slideDown()
    $("#div_alert_"+table_name).fadeOut()
    $("#"+table_name).fadeIn()
  }

  function removeRow(table_name, appraisal_id) {
    // Remove row from table. Takes into account if this is
    // the last row remaining, in that case it hides the whole
    // table and shows the no elements alert div.
    var nrows = $("#"+table_name+" tr").length;
    if (nrows > 3) {
      $("#tr_"+table_name+"-"+appraisal_id).fadeOut()
    } else {
      $("#"+table_name).fadeOut()
      $("#div_alert_"+table_name).fadeToggle()
    }
  }

  function moveRow(table_from, table_to, appraisal_id) {
    var url = "{% url 'ajax_get_appraisal_row_url' %}"
    $.ajax({
      url: url,
      type: 'get',
      data: {'appraisal_id':appraisal_id,'table':table_to},
      error: function() {
        alert("Error al cambiar fila.");
      },
      success: function (ret) {
        removeRow(table_from,appraisal_id)
        addRow(table_to,appraisal_id,ret)
        assignTableActions();
      }
    })
  }

  function replaceTable(table_name,data) {
    // Replaces a table, usuallhy from data from AJAX. Takes
    // into account the size of the table and hides the 
    // alert of no elements if the table returned has elements.
    $("#"+table_name).html($.trim(data))
    var nrows = $("#"+table_name+" tr").length;
    if (nrows == 0) {
      $("#"+table_name).fadeOut()
      $("#div_alert_"+table_name).fadeIn()
    } else {
      $("#"+table_name).fadeIn()
      $("#div_alert_"+table_name).fadeOut()
    }
  }

  var finish_appraisal = function(appraisal_id) {
    var url = "{% url 'ajax_finish_appraisal_url' %}"
    $.ajax({
      url: url,
      type: 'get',
      data: {'appraisal_id':appraisal_id},
      error: function () {
        alert("Error al finalizar tasación.");
        return false;
      },
      success: function (ret) {
        removeRow("table_in_appraisal",appraisal_id)
        replaceTable("table_finished",ret)
        assignTableActions();
      },
    })
  }

  var unfinish_appraisal = function(appraisal_id) {
    var url = "{% url 'ajax_unfinish_appraisal_url' %}"
    $.ajax({
      url: url,
      type: 'get',
      data: {'appraisal_id':appraisal_id},
      error: function () {
        alert("Error al desfinalizar tasación.");
        return false;
      },
      success: function (ret) {
        removeRow("table_finished",appraisal_id)
        replaceTable("table_in_appraisal",ret)
        assignTableActions();
      },
    })
  }

  var unvalidate_cliente = function(appraisal_id) {
    var url = "{% url 'ajax_unvalidate_cliente_url' %}"
    $.ajax({
      url: url,
      type: 'get',
      data: {'appraisal_id':appraisal_id},
      error: function () {
        alert("Error al desvalidar cliente/contacto.");
        return false;
      },
      success: function (ret) {
        return true;
      },
    })
  }

  var assignTableActions = function() {

    $(".btn_logbook").unbind()
    $(".btn_logbook").off()
    $(".btn_logbook").on("click", function (event) {
      // Opens logbook modal, and gets the data of the comments
      // from an AJAX request. Also changes a hidden input to
      // the appraisal id to have at the post request.
      event.preventDefault();
      btn = $(this)
      table = btn.data('table')
      $("#logbook").data('table',table)
      appraisal_id = btn.val(); // button has id of appraisal
      btn_loading(btn)
      // ajax
      var url = $(this).attr("data-logbook-url");
      $.ajax({
        url: url,
        type: 'get',
        data: {'appraisal_id':appraisal_id,'table':table},
        error: function () {
            alert("Error al abrir la bitacora.");
            return false;
        },
        success: function (data) {
          $('#logbook').find('.modal-body').html($.trim(data));
          $("#in_appraisal_id").val(appraisal_id); // hidden input
          $('#logbook').modal('show');
          if (table == "not_accepted") {
            $('#logbook').find('#div_event').hide()
            $('#logbook').find('#div_comment_btn').hide()
            $('#logbook').find('#div_datetime').hide()
            $('#logbook').find('#div_accept_reject').show()
          }
        },
        complete: function (data) {
          btn_idle(btn)
          assignLogbookModalActions();
          if (table != "not_accepted") {
            $("#id_event").trigger("change")
          }
        }
      });
    });

    $(".btn_delete_appraisal_modal").unbind()
    $(".btn_delete_appraisal_modal").off()
    $(".btn_delete_appraisal_modal").on("click", function (event) {
      // Called on click of delete button in the active table.
      var appraisal_id = $(this).data('appraisal_id');
      var source_table = $(this).closest('table').attr('id');
      $('#modal_delete').find('#appraisal_id').val(appraisal_id);
      $('#modal_delete').find('#source_table').val(source_table);
      $('#modal_delete').modal('show');
    });

    $("#btn_delete_appraisal").unbind()
    $("#btn_delete_appraisal").off()
    $("#btn_delete_appraisal").on("click", function (event) {
      // Button clicked in the modal. Call an AJAX to unassign the tasador
      // of the appraisal, and returns the 'not_assigned' table back,
      // to be replaced.
      var appraisal_id = $(this).closest('#modal_delete').find('#appraisal_id').val();
      var source_table = $(this).closest('#modal_delete').find('#source_table').val();
      var url = "{% url 'ajax_delete_appraisal_url' %}";
      btn = $(this);
      btn.addClass('running');
      btn.prop('disabled', true);
      $.ajax({
        url: url,
        type: 'get',
        data: {'appraisal_id':appraisal_id},
        error: function () {
            alert("Error al borrar tasación.");
            btn.removeClass('running');
            btn.prop('disabled', false);
            return false;
        },
        success: function (data) {
          btn.removeClass('running');
          btn.prop('disabled', false);
          removeRow(source_table,appraisal_id)
          assignTableActions()
          $("#modal_delete").modal('hide')
        }
      });
    });

    // --------------------------------------------------------------------------------------------
    // Assign functions are called in the 'not_assigned' table, when
    // the corresponding buttons are clicked.
    ajax_assign_tasador_modal_url = "{% url 'ajax_assign_tasador_modal_url' %}";
    ajax_assign_visador_modal_url = "{% url 'ajax_assign_visador_modal_url' %}";
    ajax_assign_tasador_url = "{% url 'ajax_assign_tasador_url' %}";
    ajax_assign_visador_url = "{% url 'ajax_assign_visador_url' %}";
    btn_assign_tasador_modal();
    btn_assign_visador_modal();
    btn_assign_tasador();
    btn_assign_visador();

    $(".visador_radio").on( "click", function() {
      $("#modal_assign_visador").find("#alert_already_chosen").hide()
    })

    // --------------------------------------------------------------------------------------------
    // Unassign functions are available in the 'active' table, to unassign
    // the current tasador or visador, and therefore put back the appraisal
    // in the 'not_assigned' table.

    $(".btn_unassign_tasador_modal").unbind()
    $(".btn_unassign_tasador_modal").off()
    $(".btn_unassign_tasador_modal").on("click", function (event) {
      // Show the modal (via bootsrap), and set the corresponding variable inside the modal
      // to the appraisal id, which is the value of the button clicked.
      var id = $(this).val();
      $('#modal_unassign_tasador_appraisal_id').val(id);
    });

    $(".btn_unassign_visador_modal").unbind()
    $(".btn_unassign_visador_modal").off()
    $(".btn_unassign_visador_modal").on("click", function (event) {
      // Show the modal (via bootsrap), and set the corresponding variable inside the modal
      // to the appraisal id, which is the value of the button clicked.
      var id = $(this).val();
      $('#modal_unassign_visador_appraisal_id').val(id);
    });

    $("#btn_unassign_tasador").unbind()
    $("#btn_unassign_tasador").off()
    $("#btn_unassign_tasador").on("click", function (event) {
      // Button clicked in the modal. Call an AJAX to unassign the tasador
      // of the appraisal, and returns the 'not_assigned' table back,
      // to be replaced.
      var appraisal_id = $('#modal_unassign_tasador_appraisal_id').val();
      var url = "{% url 'ajax_unassign_tasador_url' %}";
      btn = $(this);
      btn.addClass('running');
      btn.prop('disabled', true);
      $.ajax({
        url: url,
        type: 'get',
        data: {'appraisal_id':appraisal_id},
        error: function () {
            alert("Error al desasignar tasador.");
            btn.removeClass('running');
            btn.prop('disabled', false);
            return false;
        },
        success: function (data) {
          btn.removeClass('running');
          btn.prop('disabled', false);
          removeRow("table_in_appraisal",appraisal_id)
          replaceTable("table_not_assigned",data)
          assignTableActions()
          $("#modal_unassign_tasador").modal('hide')
        }
      });
    });

    $("#btn_unassign_visador").unbind()
    $("#btn_unassign_visador").off()
    $("#btn_unassign_visador").on("click", function (event) {
      // Button clicked in the modal. Call an AJAX to unassign the tasador
      // of the appraisal, and returns the 'not_assigned' table back,
      // to be replaced.
      var appraisal_id = $('#modal_unassign_visador_appraisal_id').val();
      var url = "{% url 'ajax_unassign_visador_url' %}";
      $.ajax({
        url: url,
        type: 'get',
        data: {'appraisal_id':appraisal_id},
        error: function () {
            alert("Error al desasignar visador.");
            return false;
        },
        success: function (data) {
          replaceTable("table_in_appraisal",data)
          assignTableActions()
          $("#modal_unassign_visador").modal('hide')
        }
      });
    });
  }

  $(document).ready(function($) {

    // Show or hide tables or empty warnings

    appraisals_not_assigned_n = {{appraisals_not_assigned|length}}
    if (appraisals_not_assigned_n > 0) {
      $("#table_not_assigned").toggle()
    } else {
      $("#div_alert_table_not_assigned").show()
    }

    appraisals_not_accepted_n = {{appraisals_not_accepted|length}}
    if (appraisals_not_accepted_n > 0) {
      $("#table_not_accepted").toggle()
    } else {
      $("#div_alert_table_not_accepted").toggle()
    }

    appraisals_in_appraisal_n = {{appraisals_in_appraisal|length}}
    if (appraisals_in_appraisal_n > 0) {
      $("#table_in_appraisal").toggle()
    } else {
      $("#div_alert_table_in_appraisal").toggle()
    }

    appraisals_in_revision_n = {{appraisals_in_revision|length}}
    if (appraisals_in_revision_n > 0) {
      $("#table_in_revision").toggle()
    } else {
      $("#div_alert_table_in_revision").toggle()
    }

    appraisals_sent_n = {{appraisals_sent|length}}
    if (appraisals_sent_n > 0) {
      $("#table_sent").toggle()
    } else {
      $("#div_alert_table_sent").toggle()
    }

    appraisals_imported_n = {{appraisals_imported|length}}
    if (appraisals_imported_n > 0) {
      $("#table_imported").toggle()
    } else {
      $("#div_alert_table_imported").toggle()
    }

    // Actions.

    assignTableActions()

    $('#logbook').on('hidden.bs.modal', function (e) {
      // When the logbook modal is closed, we delete the notifications
      // related to this appraisal. We also save the form.
      var appraisal_id = $("#in_appraisal_id").val();
      var url = "{% url 'ajax_logbook_close_url' %}";
      var form = $('#logbook_form')
      $.ajax({
        url: url,
        type: 'post',
        data: form.serialize(),
        error: function () {
            alert("Error al cerrar la bitacora.");
            return false;
        },
        success: function (data) {
          // everything is done in the view
        },
        complete: function (data) {
          // everything is done in the view
        }
      });
      return false;
    })

    $("#id_event").on('change', function (e) {
      var url = "{% url 'ajax_logbook_change_event_url' %}";
      $("#id_text").text('hola')
    });
  });

</script>

<script>
     //Handles the click true/false value of the appraisal evaluation form

  $('#evaluateAppraisal input').on('click',function(){
      var id = $(this).val();
      if (id == 'False'){
      $(this).val('True');
      }
      else {
      $(this).val('False');
      }
  });
</script>

<script>
    //Loads database values of the appraisal evaluation

    //gives appraisal and appraiser id to the input so the view knows wich appraisal and appraiser is receiving

  $(document).on('click','.evaluateAppraisal',function(){
      var id = $(this).val();
      var id2 = $(this).attr('id');
      $('#evaluadorAppraisal_id').val(id);
      $('#evaluador_id').val(id2);


      //takes the value of the data base in the data tags of the input and paste it in the corresponding appraisal evaluation
      var ontime = $(this).data('ontime');
      $('#id_onTime').val(ontime);
      var completeness = $(this).data('completeness');
      $('#id_completeness').val(completeness);
      var generalQ = $(this).data('generalquality');
      $('#id_generalQuality').val(generalQ);
      var correctS = $(this).data('correctsurface');
      $('#id_correctSurface').val(correctS);
      var completeN = $(this).data('completenormative');
      $('#id_completeNormative').val(completeN);
      var homologatedR = $(this).data('homologatedreferences');
      $('#id_homologatedReferences').val(homologatedR);
      var comment = $(this).data('commenttext');
      $('#id_commentText').val(comment);
      var feedback = $(this).data('commentfeedback');
      $('#id_commentFeedback').val(feedback);

      //this section makes the True values shows as checked and the false value as unchecked
      $( '#evaluateAppraisal input' ).each(function( index ) {
        var v = $(this).val();
          if (v == "False"){
            $(this).removeAttr('checked');
          }
          else{
            $('#evaluateAppraisal input').attr('checked');
          }
        });
      });
</script>

<script>
  $(function () {
    $('[data-toggle="tooltip"]').tooltip()
  })
</script>