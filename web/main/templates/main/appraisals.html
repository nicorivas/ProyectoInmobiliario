<script>
  function timeCreated(string) {
    var s = moment(string).format("D MMM HH:MM");
    document.write(s)
  }
</script>

<script>
  function timeLeft(string) {
    var m = moment(string);
    document.write(m.fromNow());
  }
</script>

<script>
  function timeFinished(string) {
    var s = moment(string).format("D MMM HH:MM");
    document.write(s)
  }
</script>

{% load custom_tags %}

<div class="container" style="max-width:100%">

<div class="card mb-4" id="div_activas">

  <div class="card-body">

  <h5 class="card-title">Tasaciones activas</h5>

  <div class="alert alert-primary" role="alert" id="div_no_activas" style="display: none;">
    No hay tasaciones activas
  </div>

  <table class="table table-sm table-borderless" id="table_activas">
    <thead>
      <tr>
        <th scope="col" style="width:1em">ID</th>
        <th scope="col" style="width:10em">Cliente</th>
        <th scope="col" style="width:1em;text-align:center;">T.</th>
        <th scope="col" style="width:19em;">Dirección</th>
        <th scope="col" style="width:10em;">Tasador</th>
        <th scope="col" style="width:10em;">Visador</th>
        <th scope="col" style="width:1em;text-align:center;">E.</th>
        <th scope="col" style="width:8em;">Creada</th>
        <th scope="col" style="width:8em;">Entrega</th>
        <th scope="col" style="width:5em;"></th>
      </tr>
    </thead>
    <tbody>
      {% for appraisal in appraisals_active %}
      <tr class='activas {{appraisal.tasadorUser.id}}'  id="app-{{appraisal.tasadorUser.id}}">
        <td>
          {{ appraisal.id }}
        </td>
        <td>
          {{ appraisal.solicitanteVerbose }}
        </td>
        <td style="text-align:center;">
          <i class="{{ appraisal.realEstate.get_propertyTypeIcon }}"></i>
        </td>
        <td>
          <a href="{{appraisal.url}}">
            {{ appraisal.realEstate.addressVerboseNoRegion }}
          </a>
        </td>
        <td>
          <div class="row">
            <div class="col-auto">
              <span style="vertical-align: middle;">
              {% if appraisal.tasadorUser %}
                {{ appraisal.tasadorUser.first_name.0 }}. {{ appraisal.tasadorUser.last_name }}
              {% else %}
              -
              {% endif %}
              </span>
            </div>
            {% if perms.appraisal.assign_tasador %}
            {% if appraisal.active %}
            <div class="col text-right">
              <button type="button" class="btn btn-sm asignarTasador" data-toggle="modal" data-target="#asignarTasador"
                      value="{{appraisal.id}}" style="font-family:Material Icons;font-size:1.0em;margin-bottom:1px;border:0px;">
                person_add
              </button>
            </div>
            {% endif %}
            {% endif %}
          </div>
        </td>
        <td>
          <div class="row">
            <div class="col-auto">
              <span style="vertical-align: middle;">
              {% if appraisal.visadorUser %}
                {{ appraisal.visadorUser.first_name.0 }}. {{ appraisal.visadorUser.last_name }}
              {% else %}
              -
              {% endif %}
              </span>
            </div>
            {% if perms.appraisal.assign_visador %}
            {% if appraisal.active %}
            <div class="col text-right">
              <button type="button" class="btn btn-sm asignarVisador" data-toggle="modal" data-target="#asignarVisador"
                      value="{{appraisal.id}}" style="font-family:Material Icons;font-size:1.0em;margin-bottom:1px;border:0px;">
                person_add
              </button>
            </div>
            {% endif %}
            {% endif %}
          </div>
        </td>
        <td style="text-align:center;">
          {% if appraisal.active %}
          <i class="fas fa-play"></i>
          {% elif appraisal.paused %}
          <i class="fas fa-pause"></i>
          {% endif %}
        </td>
        <td class="Creada">
          <script>timeCreated("{{appraisal.timeCreated | date:"c"}}");</script>
        </td>
        <td>
        {% if appraisal.daysLeft > 3 %}
          <p style="margin-bottom:0em;" class="font-weight-bold"><script>timeLeft("{{appraisal.timeDue|date:"c"}}");</script></p>
        {% elif appraisal.daysLeft > 1 %}
          <p style="margin-bottom:0em;" class="text-warning font-weight-bold"><script>timeLeft("{{appraisal.timeDue|date:"c"}}");</script></p>
        {% else %}
          <p style="margin-bottom:0em;" class="text-danger font-weight-bold"><script>timeLeft("{{appraisal.timeDue|date:"c"}}");</script></p>
        {% endif %}
        </td>
        <td>
        {% has_notification_appraisal request.user appraisal.id as hna %}
        <button type="button" class="btn btn-sm btn-dark {{ hna | yesno:'btn-not,' }} btn-logbook" value="{{appraisal.id}}" id="logbook_{{appraisal.id}}"
                data-logbook-url="{% url 'ajax_logbook_url' %}" style="font-family:Material Icons;font-size:1.0em;margin-bottom:1px;border:0px;">
          comment
        </button>
        <button type="button" data-id="{{appraisal.id}}" class="btn btn-dark btn-sm delete_appraisal" style="font-family:Material Icons;font-size:1.0em;margin-bottom:1px;border:0px;">
          delete
        </button>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
  </div>
</div>

<div class="card mb-4" id="div_previas">

  <div class="card-body">

  <h5 class="card-title">Tasaciones finalizadas</h5>

  <div class="alert alert-primary" role="alert" id="div_no_previas" style="display: none;">
    No hay tasaciones finalizadas
  </div>

  <table class="table table-sm table-borderless" id="table_previas">
    <thead>
      <tr>
        <th scope="col" style="width:1em">ID</th>
        <th scope="col" style="width:10em">Cliente</th>
        <th scope="col" style="width:1em;text-align:center;">T.</th>
        <th scope="col" style="width:19em">Dirección</th>
        <th scope="col" style="width:10em">Tasador</th>
        <!--<th scope="col">Fecha creación</th>-->
        <th scope="col" style="width:10em">Entregada</th>
        <th scope="col" style="width:17em"></th>
        <th scope="col" style="width:5em"></th>
      </tr>
    </thead>
    <tbody>
      {% for appraisal in appraisals_finished %}
      <tr class="previas {{appraisal.tasadorUser.id}}" id="app2-{{appraisal.tasadorUser.id}}">
        <td>
          {{ appraisal.id }}
        </td>
        <td>
          {{ appraisal.solicitanteVerbose }}
        </td>
        <td style="text-align:center;">
          <i class="{{ appraisal.realEstate.get_propertyTypeIcon }}"></i>
        </td>
        <td>
          <a href={{appraisal.url}}>
            {{ appraisal.realEstate.addressVerboseNoRegion }}
          </a>
        </td>
        <td>
          <span style="vertical-align: middle;">
            {% if appraisal.tasadorUser %}
              {{ appraisal.tasadorUser.first_name.0 }}. {{ appraisal.tasadorUser.last_name }}
            {% else %}
            -
            {% endif %}
          </span>
        </td>
        <!--
        <td>
          {{appraisal.timeCreated | date:"D d M, H:i"}}
        </td>
        -->
        <td>
          <script>timeFinished("{{appraisal.timeFinished | date:"c"}}");</script>
        </td>
        <td>
        </td>
        <td style="text-align:right;">
          <button id='btn-vis' onclick="location.href='{{appraisal.url}}'" type="button" class="btn btn-dark btn-sm btn-delete" style="font-family:Material Icons;font-size:1.0em;margin-bottom:1px;border:0px;">
            visibility
          </button>
          {% if perms.appraisal.assign_visador %}
          <button type="button" id="{{appraisal.tasadorUser.id}}" 
                  value="{{appraisal.id}}"
                  class="btn btn-dark btn-sm btn-evaluate evaluateAppraisal"
                  data-toggle="modal"
                  data-target="#evaluateAppraisal" 
                  data-ontime="{{appraisal.appraisalevaluation.onTime}}"
                  data-completeness="{{appraisal.appraisalevaluation.completeness}}"
                  data-correctsurface = "{{appraisal.appraisalevaluation.correctSurface}}"
                  data-completenormative = "{{appraisal.appraisalevaluation.completeNormative}}"
                  data-homologatedreferences = "{{appraisal.appraisalevaluation.homologatedReferences}}"
                  data-commenttext="{{appraisal.appraisalevaluation.commentText}}"
                  data-generalquality="{{appraisal.appraisalevaluation.generalQuality}}"
                  data-commentfeedback="{{appraisal.appraisalevaluation.commentFeedback}}"
                  style="font-family:Material Icons;font-size:1.0em;margin-bottom:1px;border:0px;">
            assessment
          </button>
        </td>
        {% endif %}
      </tr>
      {% endfor %}
    </tbody>
  </table>
  </div>
</div>

</div>

{% include "main/modals.html" %}

<script>

  var comment = function () {
    var form = document.getElementById('form_comment');
    var formData = new FormData(form);
    var url = $("#form_comment").attr("data-comment-url");
    $('#logbook').find('#loading').toggle()
    $.ajax({
        url: url,
        type: 'post',
        data: formData,
        processData: false,
        contentType: false,
        error: function () {
          $('#logbook').find('#loading').toggle()
          alert("Error al comentar.");
          return false;
        },
        success: function (data) {
          $('#logbook').find('#historial').html($.trim(data))
          $('#logbook').find('#loading').toggle()
        },
        complete: function (data) {
          registerCommentDeleteButtons();
        }
    });
    return false;
  }

  var registerCommentDeleteButtons = function() {
    $(".delete_comment").on('click',function() {
      console.log('hola')
      console.log($(this))
      var comment_id = $(this).data('id');
      var appraisal_id = $(this).data('appraisal-id');
      var url = $(this).data('delete-comment-url');
      console.log(url)
      $.ajax({
        url: url,
        type: 'get',
        data: {'comment_id':comment_id,'appraisal_id':appraisal_id},
        error: function () {
          alert("Error al eliminar comentario.");
          return false;
        },
        success: function (data) {
          $('#comment_'+data.comment_id).fadeOut()
        }
      });
    })
  }

  $(document).ready(function($) {

    // Tooltips.

    $('.btn-evaluate').tooltip({'title':'Evaluar'})

    $(".btn-logbook").on("click", function (event) {
      // Opens logbook modal, and gets the data of the comments
      // from an AJAX request. Also changes a hidden input to
      // the appraisal id to have at the post request.
      event.preventDefault();
      id = $(this).val(); // button has id of appraisal
      $("#in_appraisal_id").val(id); // hidden input
      // remove notification style, if there.
      $(this).removeClass('btn-not');
      //$(this).addClass('btn-dark');
      getLogbookData(id);
    });

    $("#comment").on("click", function (event) {
      // Click of comment button in comment form.
      event.preventDefault();
      comment();
    });

    $('#logbook').on('hidden.bs.modal', function (e) {
      // When the logbook modal is closed, we delete the notifications
      // related to this appraisal. For that we need AJAX
      var appraisal_id = $("#in_appraisal_id").val();
      var url = "{% url 'ajax_logbook_close_url' %}";
      $.ajax({
        url: url,
        type: 'get',
        data: {'appraisal_id':appraisal_id},
        error: function () {
            alert("Error al cerrar la bitacora.");
            return false;
        },
        success: function (data) {
          // everything is done in the view
        },
        complete: function (data) {
          // everything is done in the view
        }
      });
      return false;
    })

  });

  function getLogbookData(id) {
    var btn = $('#logbook_'+id);
    var url = btn.attr("data-logbook-url");
    $.ajax({
      url: url,
      type: 'get',
      data: {'id':id},
      error: function () {
          alert("Error al abrir la bitacora.");
          return false;
      },
      success: function (data) {
        $('#logbook').find('#historial').html($.trim(data));
        $('#logbook').modal('show');
      },
      complete: function (data) {
        registerCommentDeleteButtons();
      }
    });
    return false;
  }

  $(document).on('click','.delete_appraisal',function(){
      var id = $(this).data('id');
      $.ajax({
          url:'',
          type:'POST',
          data:{
              'id':id,
              'csrfmiddlewaretoken': $('input[name=csrfmiddlewaretoken]').val(),
          },
          success:function(data){
              $('#appraisal_id').val(id);
              $('#modalDelete').modal('show');
          },
          error:function(){
              console.log('error')
          },
      });
  });
</script>

<script>

  $(document).on('click','.asignarTasador',function(){
    // Assigns to a hidden input in the tasador modal the value of the
    // appraisal, to have in the post request.
    var id = $(this).val();
    $('#tasadorAppraisal_id').val(id);
  });

  $(document).on('click','.asignarVisador',function(){
    // Assigns to a hidden input in the visador modal the value of the
    // appraisal, to have it in the post request.
    var id = $(this).val();
    $('#visadorAppraisal_id').val(id);
  });

</script>


<script>
     //Handles the click true/false value of the appraisal evaluation form

  $('#evaluateAppraisal input').on('click',function(){
      var id = $(this).val();
      if (id == 'False'){
      $(this).val('True');
      }
      else {
      $(this).val('False');
      }
  });
</script>

<script>
    //Loads database values of the appraisal evaluation

    //gives appraisal and appraiser id to the input so the view knows with appraisal and appraiser is receiving

  $(document).on('click','.evaluateAppraisal',function(){
      var id = $(this).val();
      var id2 = $(this).attr('id');
      $('#evaluadorAppraisal_id').val(id);
      $('#evaluador_id').val(id2);

      console.log($(this).val());

      //takes the value of the data base in the data tags of the input and paste it in the corresponding appraisal evaluation
      var ontime = $(this).data('ontime');
      $('#id_onTime').val(ontime);
      var completeness = $(this).data('completeness');
      $('#id_completeness').val(completeness);
      var generalQ = $(this).data('generalquality');
      $('#id_generalQuality').val(generalQ);
      var correctS = $(this).data('correctsurface');
      $('#id_correctSurface').val(correctS);
      var completeN = $(this).data('completenormative');
      $('#id_completeNormative').val(completeN);
      var homologatedR = $(this).data('homologatedreferences');
      $('#id_homologatedReferences').val(homologatedR);
      var comment = $(this).data('commenttext');
      $('#id_commentText').val(comment);
      var feedback = $(this).data('commentfeedback');
      $('#id_commentFeedback').val(feedback);

      //this section makes the True values shows a checked and the false value unchecked
      $( '#evaluateAppraisal input' ).each(function( index ) {
        var v = $(this).val();
          if (v == "False"){
            $(this).removeAttr('checked');
          }
          else{
            $('#evaluateAppraisal input').attr('checked');
          }
        });
      });
</script>