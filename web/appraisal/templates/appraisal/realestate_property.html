<div class="row ml-4 mr-4 mt-4">
<div class="col">

  <div class="row mb-0">
    <div class="col-4">
      <!--<h5>Direcciones</h5>-->
    </div>
    <div class="col-8 text-right">
      <button class="btn btn-dark btn-sm btn_add_address_modal mb-1 mr-0">
        Agregar dirección
        <div class="ld ld-ring ld-spin" style="display:none;"></div>
      </button>
    </div>
  </div>

  <div class="mb-0" id="address_list">
    {% include 'appraisal/address_list.html' %}
  </div>

  <div class="row">
    <div class="col-3" style="padding-right:0em;">
      <div class="card rounded-0 mb-4 mt-2" style="min-height: 10em;">
        <div id="property_list" class="mr-0 mt-2">
          <!--{% include 'appraisal/property_list.html' %}-->
        </div>
      </div>
    </div>
    <div class="col-9">
      <div class="card rounded-0 mb-4 mt-2" style="min-height: 10em; padding-top:1.5em;">
        <div id="property_info" class="ml-4 mr-4">
        </div>
      </div>
    </div>
  </div>

</div>
</div>

<script>

  function set_modal_actions() {
    $("#btn_edit_address").unbind()
    $("#btn_edit_address").off()
    $('#btn_edit_address').on('click', function() {
      var btn = $(this)
      var form = $('#form_edit_address')
      btn.find('.ld').toggle();
      btn.prop('disabled', true);
      $.ajax({
        url: "{% url 'ajax_edit_address_url' %}",
        type: 'post',
        data: form.serialize(),
        error: function () {
            alert("Error al guardar nueva dirección.");
            btn.find('.ld').toggle();
            btn.prop('disabled', false);
            return false;
        },
        success: function (data) {
          btn.find('.ld').toggle();
          btn.prop('disabled', false);
          $("#li_real_estate_"+btn.val()).find('.btn_realestate_text').html(data.address)
          $("#modal_edit_address").modal('hide')
        }
      });
    })

    $("#btn_add_address").unbind()
    $("#btn_add_address").off()
    $('#btn_add_address').on('click', function() {
      var btn = $(this)
      var form = $('#form_add_address')
      btn.find('.ld').toggle();
      btn.prop('disabled', true);
      $.ajax({
        url: "{% url 'ajax_add_address_url' %}",
        type: 'post',
        data: form.serialize(),
        error: function () {
            alert("Error al agregar nueva dirección.");
            btn.find('.ld').toggle();
            btn.prop('disabled', false);
            return false;
        },
        success: function (data) {
          btn.find('.ld').toggle();
          btn.prop('disabled', false);
          $("#address_list").html($.trim(data));
          $("#modal_add_address").modal('hide');
          set_address_list_actions();
        }
      });
    })

    $("#btn_remove_address").unbind()
    $("#btn_remove_address").off()
    $('#btn_remove_address').on('click', function() {
      var btn = $(this)
      var form = $('#form_remove_address')
      btn.find('.ld').toggle();
      btn.prop('disabled', true);
      $.ajax({
        url: "{% url 'ajax_remove_address_url' %}",
        type: 'post',
        data: form.serialize(),
        error: function () {
            alert("Error al agregar nueva dirección.");
            btn.find('.ld').toggle();
            btn.prop('disabled', false);
            return false;
        },
        success: function (data) {
          btn.find('.ld').toggle();
          btn.prop('disabled', false);
          console.log(btn.val(),$("#li_real_estate_"+btn.val()))
          $("#li_real_estate_"+btn.val()).remove()
          $("#modal_remove_address").modal('hide')
        }
      });
    })
  }

  function set_property_list_actions() {

    $('.btn_property').on('click', function() {
      var btn = $(this)
      var appraisal_id = "{{appraisal.id}}"
      var real_estate_id = $("#property_list_data").data("real_estate_id")
      var building_id = btn.closest('.building_list_item').data('building_id')
      var property_id = btn.val()
      console.log(appraisal_id,real_estate_id,building_id,property_id)
      var url = "{% url 'ajax_show_property_url' %}"
      $.ajax({
        url: url,
        type: 'get',
        data: {"appraisal_id":appraisal_id,"real_estate_id":real_estate_id,"building_id":building_id,"property_id":property_id},
        error: function () {
            alert("Error al cargar información de la propiedad.");
            btn.find('.ld').toggle();
            btn.prop('disabled', false);
            return false;
        },
        success: function (data) {
          btn.find('.ld').toggle();
          btn.prop('disabled', false);
          $("#property_info").html($.trim(data));
          $('#property_info').show();
        }
      });
    })

  }

  function set_address_list_actions() {

    $('.btn_add_address_modal').on('click', function() {
      var btn = $(this)
      var appraisal_id = "{{appraisal.id}}"
      var url = "{% url 'ajax_add_address_modal_url' %}"
      btn.find('.ld').toggle();
      btn.prop('disabled', true);
      $.ajax({
        url: url,
        type: 'get',
        data: {"appraisal_id":appraisal_id},
        error: function () {
            alert("Error al cargar modal para agregar una dirección.");
            btn.find('.ld').toggle();
            btn.prop('disabled', false);
            return false;
        },
        success: function (data) {
          btn.find('.ld').toggle();
          btn.prop('disabled', false);
          $("#modal_add_address").html($.trim(data));
          $("#modal_add_address").modal('show')
          set_modal_actions()
          set_address_list_actions()
        }
      });
    })

    $('.btn_edit_address_modal').on('click', function() {
      var btn = $(this)
      var appraisal_id = "{{appraisal.id}}"
      var real_estate_id = btn.val()
      var url = "{% url 'ajax_edit_address_modal_url' %}"
      btn.find('.ld').toggle();
      btn.find('.icon').toggle();
      btn.prop('disabled', true);
      $.ajax({
        url: url,
        type: 'get',
        data: {"real_estate_id":real_estate_id,"appraisal_id":appraisal_id},
        error: function () {
            alert("Error al cargar modal para editar dirección.");
            btn.find('.ld').toggle();
            btn.find('.icon').toggle();
            btn.prop('disabled', false);
            return false;
        },
        success: function (data) {
          btn.find('.ld').toggle();
          btn.find('.icon').toggle();
          btn.prop('disabled', false);
          $('#modal_edit_address').html($.trim(data));
          $("#modal_edit_address").modal('show')
          set_modal_actions()
          set_address_list_actions()
        }
      });
    })

    $('.btn_remove_address_modal').on('click', function() {
      var btn = $(this)
      var appraisal_id = "{{appraisal.id}}"
      var real_estate_id = btn.val()
      var url = "{% url 'ajax_remove_address_modal_url' %}"
      btn.find('.ld').toggle();
      btn.find('.icon').toggle();
      btn.prop('disabled', true);
      $.ajax({
        url: url,
        type: 'get',
        data: {"real_estate_id":real_estate_id,"appraisal_id":appraisal_id},
        error: function () {
            alert("Error al cargar modal para eliminar dirección.");
            btn.find('.ld').toggle();
            btn.find('.icon').toggle();
            btn.prop('disabled', false);
            return false;
        },
        success: function (data) {
          btn.find('.ld').toggle();
          btn.find('.icon').toggle();
          btn.prop('disabled', false);
          $('#modal_remove_address').html($.trim(data));
          $("#modal_remove_address").modal('show')
          set_modal_actions()
        }
      });
    })

    $('.btn_realestate').on('click', function() {
      var btn = $(this)
      var appraisal_id = "{{appraisal.id}}"
      var real_estate_id = btn.val()
      var url = "{% url 'ajax_load_realestate_url' %}"
      btn.find('.ld').toggle();
      btn.prop('disabled', true);
      btn.addClass("border border-primary")
      $("#address_list").find(".btn_realestate").each(function() {
        $(this).removeClass("border border-primary")
      })
      btn.addClass("border border-primary")
      $.ajax({
        url: url,
        type: 'get',
        data: {"real_estate_id":real_estate_id,"appraisal_id":appraisal_id},
        error: function () {
            alert("Error al cargar dirección.");
            btn.find('.ld').toggle();
            btn.prop('disabled', false);
            return false;
        },
        success: function (data) {
          btn.find('.ld').toggle();
          btn.prop('disabled', false);
          $('#property_info').fadeOut();
          $('#property_list').html($.trim(data));
          set_property_list_actions();
        }
      });
    })
  }

  $(document).ready(function($) {
    set_address_list_actions()
  })

</script>