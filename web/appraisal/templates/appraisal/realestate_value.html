<div id="accordion">
  <div class="card ml-4 mr-4 mt-4 rounded-0">
    <div class="card-header bg-light" id="header">
      <div class="row">
      <div class="col">
        <p style="margin:0em;">Valor recomendado</p>
      </div>
      <div class="col text-right">
        <a class="btn" style="font-family:Material Icons;font-size:1em;margin-top:-1.0em;margin-bottom:-1.0em;" data-toggle="collapse" href="#recommendedValue" role="button" aria-expanded="false" aria-controls="multiCollapseExample1">
          more_vert
        </a>
      </div>
      </div>
    </div>
    <div id="recommendedValue" class="collapse show" aria-labelledby="heading">
    <div class="card-body" style="padding:0em;">

      <table class="table mb-0">
        <thead class="thead">
          <tr>
            <th scope="col"></th>
            <th scope="col" style="width:10em;"></th>
            <th scope="col" style="width:7em;"></th>
            <th scope="col" style="text-align:center;width:10em;">U.F.</th>
            <th scope="col" style="text-align:center;width:10em;">$</th>
            <th scope="col"></th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td scope="col"></td>
            <td scope="col" style="vertical-align: middle;">Valor comercial</td>
            <td scope="col"></td>
            <td scope="col">{{forms.appraisal.valorUF}}</td>
            <td scope="col"><input id="in_value_market" class="form-control text-right" disabled></td>
            <td scope="col"></td>
          </tr>
          <tr>
            <td scope="col"></td>
            <td scope="col" style="vertical-align: middle;">Valor liquidez</td>
            <td scope="col"><input id="liquidity" class="form-control text-right" type="text" value="0,75"></td>
            <td scope="col"><input id="in_value_liquid_UF" class="form-control text-right" disabled></td>
            <td scope="col"><input id="in_value_liquid" class="form-control text-right" disabled></td>
            <td scope="col"></td>
          </tr>
          <tr>
            <td scope="col"></td>
            <td scope="col" style="vertical-align: middle;">Monto seguro</td>
            <td scope="col"></td>
            <td scope="col"><input id="in_value_safe_UF" class="form-control text-right" disabled></td>
            <td scope="col"><input id="in_value_safe" class="form-control text-right" disabled></td>
            <td scope="col"></td>
          </tr>
        </tbody>
      </table>

    </div>
    </div>
  </div>

<div class="card ml-4 mr-4 mt-4 rounded-0">
  <div class="card-header" id="header">
    <div class="row">
      <div class="col">
        <p style="margin:0em;">Valor de renta</p>
      </div>
      <div class="col text-right">
        <a class="btn" style="font-family:Material Icons;font-size:1em;margin-top:-1.0em;margin-bottom:-1.0em;" data-toggle="collapse" href="#valuation_rent" role="button" aria-expanded="false" aria-controls="multiCollapseExample1">
          more_vert
        </a>
      </div>
    </div>
  </div>
  <div id="valuation_rent" class="collapse show" aria-labelledby="heading">
    <div class="card-body" style="padding:0em;">
      <table id="table_valuation_rent" class="table table-sm mb-0">
        <thead class="thead">
          <tr style="text-align:center;">
            <th></th>
            <th style="width:16em;">Renta mensual {{htmlBits.unitUF|safe}}</th>
            <th style="width:5em;">Meses</th>
            <th style="width:16em;">Renta líquida anual {{htmlBits.unitUF|safe}}</th>
            <th style="width:5em;">Tasa</th>
            <th style="width:16em;">Canon arriendo {{htmlBits.unitUFperSquaredMeter|safe}}</th>
            <th style="width:16em;">Valor de renta {{htmlBits.unitUF|safe}}</th>
            <th></th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td></td>
            <td>
              <input id="id_value_rent_month" class="form-control form-control-sm text-right" disabled>
            </td>
            <td>
              <input id="id_value_rent_months" class="form-control form-control-sm text-center" disabled>
            </td>
            <td>
              <input id="id_value_rent_year" class="form-control form-control-sm text-right" disabled>
            </td>
            <td>
              <input id="id_value_rent_rate" class="form-control form-control-sm text-right" disabled>
            </td>
            <td>
              <input id="id_value_rent_per_area" class="form-control form-control-sm text-right" disabled>
            </td>
            <td>
              <input id="id_value_rent" class="form-control form-control-sm text-right" disabled>
            </td>
            <td></td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
</div>

<div class="card ml-4 mr-4 mt-4 rounded-0">
  <div class="card-header" id="header">
    <div class="row">
      <div class="col">
        <p style="margin:0em;">Muestras comparativas</p>
      </div>
      <div class="col text-right">
        <a class="btn" style="font-family:Material Icons;font-size:1em;margin-top:-1.0em;margin-bottom:-1.0em;" data-toggle="collapse" href="#valuationRealEstate" role="button" aria-expanded="false" aria-controls="multiCollapseExample1">
          more_vert
        </a>
      </div>
    </div>
  </div>

  {% load l10n %}
  {% localize on %}

  <div id="valuationRealEstate" class="collapse show" aria-labelledby="heading">
    <div class="card-body" style="padding:0em;">
      <table id="tableValuationRealEstate" class="table table-sm mb-0">

        <thead class="thead">
          <tr>
            <!--<th scope="col">lat/lng</th>-->
            <th></th>
            <th scope="col" style="width: 1em;text-align:right;">#</th>
            <th scope="col" style="width: 20em;text-align:left;">Dirección</th>
            <th scope="col" style="width: 4em;text-align:center;">Tipo</th>
            <th scope="col" style="width: 4em;text-align:center;">Fuente</th>
            <th scope="col" style="width: 3em;text-align:center;"><i class="fas fa-bed"></i></th>
            <th scope="col" style="width: 3em;text-align:center;"><i class="fas fa-bath"></i></th>
            {% if realestate.is_house %}
            <th scope="col" style="width: 7em;text-align:right;">m<sup>2</sup> const.</th>
            <th scope="col" style="width: 7em;text-align:right;">m<sup>2</sup> terreno</th>
            {% elif realestate.is_apartment %}
            <th scope="col" style="width: 7em;text-align:right;">m<sup>2</sup> útil</th>
            <th scope="col" style="width: 7em;text-align:right;">m<sup>2</sup> terraza</th>
            {% endif %}
            <th scope="col" style="width: 10em;text-align:right;">Valor comercial</th>
            {% if realestate.is_house %}
            <th scope="col" style="width: 10em;text-align:right;">V.C./ m<sup>2</sup> con.</th>
            <th scope="col" style="width: 10em;text-align:right;">V.C./ m<sup>2</sup> tot.</th>
            {% elif realestate.is_apartment %}
            <th scope="col" style="width: 10em;text-align:right;">V.C./ m<sup>2</sup> útil</th>
            <th scope="col" style="width: 10em;text-align:right;">V.C./ m<sup>2</sup> tot.</th>
            {% endif %}
            <th scope="col" style="width: 5em;"></th>
            <th></th>
          </tr>
        </thead>

        <tbody>
          <tr class="table-warning">
            <!--<td><small>{{realestate.latlng_verbose}}</small></td>-->
            <td></td>
            <td></td>
            <td scope="row">{{realestate.addressStreet}} {{realestate.addressNumber}}</td>
            <td style="text-align:center;"><i class="{{realestate.get_propertyTypeIcon}}"></i></td>
            <td></td>
            {% if realestate.is_house %}
            <td style="text-align:center;">{{realestate.apartment.bedrooms|default_if_none:"-"}}</td>
            <td style="text-align:center;">{{realestate.apartment.bathrooms|default_if_none:"-"}}</td>
            <td style="text-align:right;">{{realestate.house.builtSquareMeters|default_if_none:"-"}}</td>
            <td style="text-align:right;">{{realestate.house.terrainSquareMeters|default_if_none:"-"}}</td>
            {% elif realestate.is_apartment %}
            <td style="text-align:center;">{{realestate.apartment.bedrooms|default_if_none:"-"}}</td>
            <td style="text-align:center;">{{realestate.apartment.bathrooms|default_if_none:"-"}}</td>
            <td style="text-align:right;">{{realestate.apartment.usefulSquareMeters|default_if_none:"-"}}</td>
            <td style="text-align:right;">{{realestate.apartment.terraceSquareMeters|default_if_none:"-"}}</td>
            {% endif %}
            <td class="td_cre_market_price" style="text-align:right;"></td>
            {% if realestate.is_house %}
            <td class="td_cre_market_price_per_built_square_meters" style="text-align:right;"></td>
            <td class="td_cre_market_price_per_total_square_meters" style="text-align:right;"></td>
            {% elif realestate.is_apartment %}
            <td class="td_cre_market_price_per_useful_square_meters" style="text-align:right;"></td>
            <td class="td_cre_market_price_per_total_square_meters" style="text-align:right;"></td>
            {% endif %}
            <td></td>
            <td></td>
          </tr>

          {% for o in appraisal.valuationRealEstate.all %}
          <tr id="trValuationRealEstate_{{o.id}}">
            <input name="valuationRealEstateRow" type="hidden" value="{{o.id}}">
            <input id="in_valuationRealEstateRemove" name="valuationRealEstateRemove" type="hidden" value="0">
            <!--<td><small>{{o.latlng_verbose}}</small></td>-->
            <td></td>
            <td style="text-align:right;"><small>{{forloop.counter}}.</small></td>
            <td scope="row">{{o.addressStreet}} {{o.addressNumber}}</td>
            <td style="text-align:center;"><i class="{{o.get_propertyTypeIcon }}"></i></td>
            <td><a href="{{o.sourceUrl}}">{{ o.sourceNameNice }}</a></td>
            <td style="text-align:center;">{{ o.apartment.bedrooms }}</td>
            <td style="text-align:center;">{{ o.apartment.bathrooms }}</td>
            {% if o.is_house %}
            <td class="tdBuiltSquareMeters" style="text-align:right;" >{{ o.house.builtSquareMetersVerbose }}</td>
            <td class="tdTerrainSquareMeters" style="text-align:right;" >{{ o.house.terrainSquareMetersVerbose }}</td>
            {% elif o.is_apartment %}
            <td class="tdUsefulSquareMeters" style="text-align:right;" >{{ o.apartment.usefulSquareMetersVerbose }}</td>
            <td class="tdTerraceSquareMeters" style="text-align:right;" >{{ o.apartment.terraceSquareMetersVerbose }}</td>
            {% endif %}
            <td class="tdMarketPrice" style="text-align:right;">{{ o.marketPrice }}</td>
            {% if o.is_house %}
            <td class="tdMarketPricePerBuiltSquareMeters" style="text-align:right;">{{ o.house.marketPricePerBuiltSquareMeters }}</td>
            <td class="tdMarketPricePerTotalSquareMeters" style="text-align:right;">{{ o.house.marketPricePerTotalSquareMeters }}</td>
            {% elif o.is_apartment %}
            <td class="tdMarketPricePerUsefulSquareMeters" style="text-align:right;">{{ o.apartment.marketPricePerUsefulSquareMeters }}</td>
            <td class="tdMarketPricePerTotalSquareMeters" style="text-align:right;">{{ o.apartment.marketPricePerTotalSquareMeters }}</td>
            {% endif %}
            <td style="padding:0em;text-align:right;">
              <button type="button" class="btn btn-sm removeValuationRealEstate" name="btn_valuation_add_realestate" value="{{o.id}}" style="padding:0px; border:0px;">
                <i class="material-icons">delete</i>
              </button>
            </td>
            <td></td>
          </tr>
          {% endfor %}

          <tr>
            <td></td>
            <td></td>
            <td><input class="form-control form-control-sm form-control-inline" style="min-width:0;display:inline;"></input></td>
            <td><input class="form-control form-control-sm"></input></td>
            <td><input class="form-control form-control-sm"></input></td>
            <td><input class="form-control form-control-sm"></input></td>
            <td><input class="form-control form-control-sm"></input></td>
            <td><input class="form-control form-control-sm"></input></td>
            <td><input class="form-control form-control-sm"></input></td>
            <td><input class="form-control form-control-sm"></input></td>
            <td></td>
            <td></td>
            <td style="padding:0em;text-align:right;">
              <button type="button" class="btn btn-sm" data-toggle="modal" data-target="#addRealEstate" style="padding:0px; border:0px; text-align:right;">
                <i class="material-icons">add_box</i>
              </button>
            </td>
            <td></td>
          </tr>

          <tr class="table-primary">
            <td></td>
            <td></td>
            <th scope="row">Promedios</th>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
            <td id='vreUsefulSquareMetersAvg' style="text-align:right;"></td>
            <td id='vreTerraceSquareMetersAvg' style="text-align:right;"></td>
            <td id='vreMarketPriceAvg' style="text-align:right;"></td>
            <td id='vreMarketPricePerUsefulSquareMetersAvg' style="text-align:right;"></td>
            <td id='vreMarketPricePerTotalSquareMetersAvg' style="text-align:right;"></td>
            <td></td>
            <td></td>
          </tr>

        </tbody>

      </table>
    </div>
  </div>

  {% endlocalize %}

</div>

<div class="card ml-4 mr-4 mt-4 rounded-0">
  <div class="card-header" id="header">
    <div class="row">
      <div class="col">
        <p style="margin:0em;">Muestras de mercado</p>
      </div>
      <div class="col text-right">
        <a class="btn" style="font-family:Material Icons;font-size:1em;margin-top:-1.0em;margin-bottom:-1.0em;" data-toggle="collapse" href="#realEstateMarket" role="button" aria-expanded="false" aria-controls="multiCollapseExample1">
          more_vert
        </a>
      </div>
    </div>
  </div>
  <div id="realEstateMarket" class="collapse" aria-labelledby="heading">
    <div class="card-body" style="padding:0em;margin:0em;">
      {% if references|length_is:"0" %}
        <div class="alert alert-light ml-3 mr-3 mt-4" role="alert">
          <h4 class="alert-heading">No existen referencias</h4>
          <p>Probablemente no se han ingresado suficientes datos para obtener propiedades similares</p>
        </div>
      {% else %}
      <table id="tableMarketRealEstate" class="table table-sm mb-0">

        <thead class="thead">

          <tr>
            <th></th>
            <th scope="col" style="width: 1em;text-align:right;">#</th>
            <th scope="col" style="width: 20em;text-align:left;">Dirección</th>
            <th scope="col" style="width: 4em;text-align:center;">Tipo</th>
            <th scope="col" style="width: 4em;text-align:center;">Fuente</th>
            <th scope="col" style="width: 3em;text-align:center;"><i class="fas fa-bed"></i></th>
            <th scope="col" style="width: 3em;text-align:center;"><i class="fas fa-bath"></i></th>
            {% if realestate.is_house %}
            <th scope="col" style="width: 7em;text-align:right;">m<sup>2</sup> const.</th>
            <th scope="col" style="width: 7em;text-align:right;">m<sup>2</sup> terreno</th>
            {% elif realestate.is_apartment %}
            <th scope="col" style="width: 7em;text-align:right;">m<sup>2</sup> útil</th>
            <th scope="col" style="width: 7em;text-align:right;">m<sup>2</sup> terraza</th>
            {% endif %}
            <th scope="col" style="width: 10em;text-align:right;">Valor comercial</th>
            {% if realestate.is_house %}
            <th scope="col" style="width: 10em;text-align:right;">V.C./ m<sup>2</sup> con.</th>
            <th scope="col" style="width: 10em;text-align:right;">V.C./ m<sup>2</sup> tot.</th>
            {% elif realestate.is_apartment %}
            <th scope="col" style="width: 10em;text-align:right;">V.C./ m<sup>2</sup> útil</th>
            <th scope="col" style="width: 10em;text-align:right;">V.C./ m<sup>2</sup> tot.</th>
            {% endif %}
            <th scope="col" style="width: 5em;"></th>
            <th></th>
          </tr>

        </thead>

        <tbody>

          <tr class="table-warning">
            <td></td>
            <td></td>
            <td scope="row">{{realestate.addressStreet}} {{realestate.addressNumber}}</td>
            <td style="text-align:center;"><i class="{{realestate.get_propertyTypeIcon }}"></i></td>
            <td></td>
            {% if realestate.is_house %}
            <td style="text-align:center;">{{realestate.apartment.bedrooms|default_if_none:"-"}}</td>
            <td style="text-align:center;">{{realestate.apartment.bathrooms}}</td>
            <td style="text-align:right;">{{realestate.house.builtSquareMeters}}</td>
            <td style="text-align:right;">{{realestate.house.terrainSquareMeters}}</td>
            {% elif realestate.is_apartment %}
            <td style="text-align:center;">{{realestate.apartment.bedrooms|default_if_none:"-"}}</td>
            <td style="text-align:center;">{{realestate.apartment.bathrooms|default_if_none:"-"}}</td>
            <td style="text-align:right;">{{realestate.apartment.usefulSquareMeters|default_if_none:"-"}}</td>
            <td style="text-align:right;">{{realestate.apartment.terraceSquareMeters|default_if_none:"-"}}</td>
            {% endif %}
            <td class="td_cre_market_price" style="text-align:right;"></td>
            {% if realestate.is_house %}
            <td class="td_cre_market_price_per_built_square_meters" style="text-align:right;"></td>
            <td class="td_cre_market_price_per_total_square_meters" style="text-align:right;"></td>
            {% elif realestate.is_apartment %}
            <td class="td_cre_market_price_per_useful_square_meters" style="text-align:right;"></td>
            <td class="td_cre_market_price_per_total_square_meters" style="text-align:right;"></td>
            {% endif %}
            <td></td>
            <td></td>
          </tr>

          {% for r in references %}
          {% if r.included_in_valuation %} 
          <tr class="table-success" id="trMarketRealEstate_{{r.realestate.id}}" value="{{r.realestate.id}}">
          {% else %}
          <tr id="trMarketRealEstate_{{r.realestate.id}}" value="{{r.realestate.id}}">
          {% endif %}
            <!--<td><small>{{o.latlng_verbose}}</small></td>-->
            <td></td>
            <td style="text-align:right;">
              <small>{{forloop.counter}}.</small>
            </td>
            <td scope="row">
              {{r.realestate.addressStreet}} {{r.realestate.addressNumber}}
            </td>
            <td style="text-align:center;">
              <i class="{{r.realestate.get_propertyTypeIcon }}"></i>
            </td>
            <td>
              <a href="{{r.realestate.sourceUrl}}" target="_blank">{{ r.realestate.sourceNameNice }}</a>
            </td>
            <td style="text-align:center;">
              {{ r.realestate.bedrooms }}
            </td>
            <td style="text-align:center;">
              {{ r.realestate.bathrooms }}
            </td>
            {% if r.realestate.is_house %}
            <td class="tdBuiltSquareMeters" style="text-align:right;">
              {{ r.realestate.builtSquareMetersVerbose }}
            </td>
            <td class="tdTerrainSquareMeters" style="text-align:right;">
              {{ r.realestate.terrainSquareMetersVerbose }}
            </td>
            {% elif realestate.is_apartment %}
            <td class="tdUsefulSquareMeters" style="text-align:right;">
              {{ r.realestate.usefulSquareMetersVerbose }}
            </td>
            <td class="tdTerraceSquareMeters" style="text-align:right;">
              {{ r.realestate.terraceSquareMetersVerbose }}
            </td>
            {% endif %}
            <td class="tdMarketPrice" style="text-align:right;">
              {{ r.realestate.marketPrice }}
            </td>
            {% if realestate.is_house %}
            <td class="tdMarketPricePerBuiltSquareMeters" style="text-align:right;">
              {{ r.realestate.marketPricePerBuiltSquareMeters }}
            </td>
            <td class="tdMarketPricePerTotalSquareMeters" style="text-align:right;">
              {{ r.realestate.marketPricePerTotalSquareMeters }}
            </td>
            {% elif realestate.is_apartment %}
            <td class="tdMarketPricePerUsefulSquareMeters" style="text-align:right;">
              {{ r.realestate.marketPricePerUsefulSquareMeters }}
            </td>
            <td class="tdMarketPricePerTotalSquareMeters" style="text-align:right;">
              {{ r.realestate.marketPricePerTotalSquareMeters }}
            </td>
            {% endif %}
            <td style="padding:0em; text-align:right;">
              {% if r.included_in_valuation %} 
              <button type="button" class="btn btn-sm add" name="btn_valuation_add_realestate" value="{{r.realestate.id}}" style="padding:0px; border:0px;display: none;">
                <i class="material-icons">add_box</i>
              </button>
              {% else %}
              <button type="button" class="btn btn-sm add" name="btn_valuation_add_realestate" value="{{r.realestate.id}}" style="padding:0px; border:0px;">
                <i class="material-icons">add_box</i>
              </button>
              {% endif %}
            </td>
            <td></td>
          </tr>
          {% endfor %}

          <tr class="table-primary">
            <td></td>
            <td></td>
            <td>Promedios</td>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
            {% if realestate.is_apartment %}
            <td style="text-align:right;">{{ averages.usefulSquareMeters__avg | floatformat:1}} &plusmn; 
                <small>{{ stds.usefulSquareMeters__stddev | floatformat:1 }}</small></td>
            <td style="text-align:right;">{{ averages.terraceSquareMeters__avg | floatformat:1 }} &plusmn; 
                <small>{{ stds.terraceSquareMeters__stddev | floatformat:1 }}</small></td>
            <td style="text-align:right;">{{ averages.marketPrice__avg | floatformat:1 }} &plusmn; 
                <small>{{ stds.marketPrice__stddev | floatformat:1 }}</small></td>
            {% elif realestate.is_house %}
            <td style="text-align:right;">{{ averages.builtSquareMeters__avg | floatformat:1}} &plusmn; 
                <small>{{ stds.builtSquareMeters__stddev | floatformat:1 }}</small></td>
            <td style="text-align:right;">{{ averages.terrainSquareMeters__avg | floatformat:1 }} &plusmn; 
                <small>{{ stds.terrainSquareMeters__stddev | floatformat:1 }}</small></td>
            <td style="text-align:right;">{{ averages.marketPrice__avg | floatformat:1 }} &plusmn; 
                <small>{{ stds.marketPrice__stddev | floatformat:1 }}</small></td>
            {% endif %}
            <td></td>
            <td></td>
            <td></td>
            <td></td>
          </tr>

        </tbody>
      </table>
      {% endif %}
    </div>
  </div>
</div>

<!--
<div class="card ml-4 mr-4 mt-4 rounded-0">
  <div class="card-header" id="header">
    <div class="row">
      <div class="col">
        <p style="margin:0em;">Muestras CBR</p>
      </div>
      <div class="col text-right">
        <a class="btn" style="font-family:Material Icons;font-size:1em;margin-top:-1.0em;margin-bottom:-1.0em;" data-toggle="collapse" href="#realEstateCBR" role="button" aria-expanded="false" aria-controls="multiCollapseExample1">
          more_vert
        </a>
      </div>
    </div>
  </div>
</div>
-->

<div class="card ml-4 mr-4 mt-4 mb-4 rounded-0">
  <div class="card-header" id="header">
    <div class="row">
      <div class="col">
        <p style="margin:0em;">Mapa propiedades</p>
      </div>
      <div class="col text-right">
        <a class="btn" style="font-family:Material Icons;font-size:1em;margin-top:-1.0em;margin-bottom:-1.0em;" data-toggle="collapse" href="#map" role="button" aria-expanded="false" aria-controls="multiCollapseExample1">
          more_vert
        </a>
      </div>
    </div>
  </div>
  <div id="map" class="collapse" aria-labelledby="heading">
    <div class="card-body">
      <div class="row">
        <div class="col">
          <div style="display: table;margin: auto;">
            {{ plot_map.div | safe }}
            {{ plot_map.script | safe }}
          </div>
        </div>
      </div>
    </div>
  </div>
</div>


<div class="card ml-4 mr-4 mt-4 mb-4 rounded-0">
  <div class="card-header" id="header">
    <div class="row">
      <div class="col">
        <p style="margin:0em;">Avalúos</p>
      </div>
      <div class="col text-right">
        <a class="btn" style="font-family:Material Icons;font-size:1em;margin-top:-1.0em;margin-bottom:-1.0em;" data-toggle="collapse" href="#avaluos" role="button" aria-expanded="false" aria-controls="multiCollapseExample1">
          more_vert
        </a>
      </div>
    </div>
  </div>
  <div id="avaluos" class="collapse show" aria-labelledby="heading">
    <div class="card-body" style="padding:0em;margin:0em;">

      <table id="table_constructions" class="table table-sm mb-0">

        <thead class="thead">
          <!-- Headers !-->
          <tr>
            <th></th>
            <th scope="col" colspan="5" style="width: 30em;"></th>
            <th scope="col" style="width: 1em;">Un.</th>
            <th scope="col" style="width: 5em;text-align:right;">Cantidad</th>
            <th scope="col" style="width: 5em;text-align:right;">$/m<sup>2</sup></th>
            <th scope="col" style="width: 5em;text-align:right;">UF/m<sup>2</sup></th>
            <th scope="col" style="width: 5em;text-align:right;">{{htmlBits.unitPesos|safe}}</th>
            <th scope="col" style="width: 5em;text-align:right;">{{htmlBits.unitUF|safe}}</th>
            <th scope="col" style="width: 7em;text-align:right;">Visado {{htmlBits.unitUF|safe}}</th>
            <th scope="col" style="width: 7em;text-align:right;"></th>
            <th scope="col" style="width: 4em;"></th>
            <th></th>
          </tr>
        </thead>

        <tbody>

          <!-- Terrains, only activated when real estate is house !-->
          {% if realestate.is_house %}
          <tr class="table-warning">
            <td></td>
            <td>Terreno</td>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
          </tr>

          {% for ter in realestate.terrains.all %}
          <tr class="tr_terrain">
            <!-- Hidden inputs are used for processing the form. 
              Terrain id to get if the obejct exists !-->
            <input type="hidden" name="terrain_id" id="in_terrain_id" value="{{ter.id}}">
            <!-- And edited, to see if we have to consider this row. See comment in view. !-->
            <input type="hidden" name="terrain_edited" id="in_terrain_edited" value="0">
            <td></td>
            <td id='td_name' colspan="5" style="font-size:0.85em;">
              {{ter.name}}
            </td>
            <td style="font-size:0.85em;">m<sup>2</sup></td>
            <td>
              <input id="id_terrainArea" type="number" name="t-area" step="any" class="form-control form-control-sm constructions" style="width:100%;text-align:right;" value="{{ter.area}}">
            </td>
            <td>
              <input id="id_terrainPesosPerArea" class="form-control form-control-sm constructions" style="width:100%;text-align:right;" readonly="true">
            </td>
            <td>
              <input id="id_terrainUFPerArea" type="number" name="t-UFPerArea" step="any" class="form-control form-control-sm constructions" style="width:100%;text-align:right;" value="{{ter.UFPerArea}}">
            </td>
            <td>
              <input id="id_terrainPesos" class="form-control form-control-sm constructions" style="width:100%;text-align:right;" readonly="true">
            </td>
            <td>
              <input id="id_terrainUF" class="form-control form-control-sm constructions" style="width:100%;text-align:right;" readonly="true">
            </td>
            <td>
              <input id="id_terrainVisadoUF" class="form-control form-control-sm constructions" style="width:100%;text-align:right;" readonly="true">
            </td>
            <td>
            </td>
            <td style="padding:0em;text-align:right;">
              <button class="btn btn-sm save_terrain" name="btn_valuation_add_terrain" style="padding:0px; border:0px; display: none;">
                <i class="material-icons">save</i>
              </button>
              <button class="btn btn-sm edit_terrain" type="button" value="{{ter.id}}" style="padding:0px; border:0px;">
                <i class="material-icons">edit</i>
              </button>
              <button class="btn btn-sm" name="btn_valuation_remove_terrain" value="{{ter.id}}" style="padding:0px; border:0px;">
                <i class="material-icons">delete</i>
              </button>
            </td>
            <td></td>
          </tr>
          {% endfor %}

          <!-- This row is here to be copied when the add terrain is clicked -->
          <tr id='tr_create_terrain' style="display:none;">
            <input id="in_terrain_id" type="hidden" name="terrain_id" value="-1">
            <input id="in_terrain_edited" type="hidden" name="terrain_edited" value="0">
            <td></td>
            <td colspan="5">
              {{forms.createTerrain.name}}
            </td>
            <td>
              m<sup>2</sup>
            </td>
            <td>
              {{forms.createTerrain.area}}
            </td>
            <td>
              <input id="id_terrainPesosPerArea" class="form-control form-control-sm constructions" style="width:100%;" readonly="true">
            </td>
            <td>
              {{forms.createTerrain.UFPerArea}}
            </td>
            <td>
              <input id="id_terrainPesos" class="form-control form-control-sm constructions" style="width:100%;" readonly="true">
            </td>
            <td>
              <input id="id_terrainUF" class="form-control form-control-sm constructions" style="width:100%;" readonly="true">
            </td>
            <td>
              <input id="id_terrainVisadoUF" class="form-control form-control-sm constructions" style="width:100%;" readonly="true">
            </td>
            <td></td>
            <td style="padding:0em;text-align:right;">
              <button class="btn btn-sm" name="btn_valuation_add_terrain" style="padding:0px; border:0px;">
                <i class="material-icons">save</i>
              </button>
            </td>
            <td></td>
          </tr>
          <!-- This row only contains the add button -->
          <tr>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
            <!--<td colspan="2"><div class="btn btn-dark btn-sm"> Agregar construcción </btn></td>-->
            <td></td>
            <td></td>
            <td style="padding:0em;text-align:right;">
              <button id="add_terrain" type="button" class="btn btn-sm" name="btn_valuation_add_terrain" style="padding:0px; border:0px;">
                <i class="material-icons">add_box</i>
              </button>
            </td>
            <td></td>
          </tr>
          <tr class="table-secondary">
            <td></td>
            <td style="font-size:0.85em;">Subtotal</td>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
            <td id='id_ptotalTerrArea' style="text-align:right;font-size:0.85em;"></td>
            <td id='id_ptotalTerrPesosPerArea' style="text-align:right;font-size:0.85em;"></td>
            <td id='id_ptotalTerrUFPerArea' style="text-align:right;font-size:0.85em;"></td>
            <td id='id_ptotalTerrPesos' style="text-align:right;font-size:0.85em;"></td>
            <td id='id_ptotalTerrUF' style="text-align:right;font-size:0.85em;"></td>
            <td id='id_ptotalTerrVisadoUF' style="text-align:right;font-size:0.85em;"></td>
            <td></td>
            <td></td>
            <td></td>
          </tr>
          {% endif %}

          <!-- Subdivision of table for constructions !-->
          <tr class="table-warning">
            <td></td>
            <td style="width: 16em;">Construcciones</td>
            <td style="width: 5em;font-size:0.85em;">Material</td>
            <td style="width: 5em;font-size:0.85em;">Año</td>
            <td style="width: 3em;font-size:0.85em;">Prenda</td>
            <td style="width: 3em;font-size:0.85em;">Recep.</td>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
          </tr>

          <!-- Iterate over constructions !-->
          {% for con in realestate.constructions.all %}
          <tr class="tr_construction">
            <!-- Hidden inputs are used for processing the form. 
              Construction id to get if the obejct exists !-->
            <input type="hidden" name="construction_id" id="in_construction_id" value="{{con.id}}">
            <!-- And edited, to see if we have to consider this row. See comment in view. !-->
            <input type="hidden" name="construction_edited" id="in_construction_edited" value="0">
            <td></td>
            <td id='td_name' style="font-size:0.85em;">
              {{con.name}}
            </td>
            <td id='td_material' style="font-size:0.85em;">
              {{con.get_material_display}}
            </td>
            <td id='td_year' style="font-size:0.85em;">
              <span>{{con.year|date:'Y'}}</span>
              <!--
              <div class="input-group date" id="datetimepicker4" data-target-input="nearest" style="display:none;">
                <div class="input-group-append" data-target="#datetimepicker4" data-toggle="datetimepicker">
                  <div class="input-group-text">
                    <i class="fa fa-calendar"></i>
                  </div>
                </div>
              </div>
              -->
            </td>
            
            <!--
            <script type="text/javascript">
              $(function () {
                $('#datetimepicker4').datetimepicker({
                  format: 'YYYY-MM-DD'
                });
              });
            </script>
            -->
            
            <td id='td_prenda' style="font-size:0.85em;">
              {{con.get_prenda_display}}
            </td>
            <td id='td_recepcion' style="font-size:0.85em;">
              {{con.get_recepcion_display}}
            </td>
            <td style="font-size:0.85em;">
              m<sup>2</sup>
            </td>
            <td>
              <input id="id_consArea" type="number" name="c-area" step="any" class="form-control form-control-sm constructions" style="width:100%;text-align:right;" value="{{con.area}}">
            </td>
            <td>
              <input id="id_consPesosPerArea" class="form-control form-control-sm constructions" style="width:100%;text-align:right;" readonly="true">
            </td>
            <td>
              <input id="id_consUFPerArea" type="number" name="c-UFPerArea" step="any" class="form-control form-control-sm constructions" style="width:100%;text-align:right;" value="{{con.UFPerArea}}">
            </td>
            <td>
              <input id="id_consPesos" class="form-control form-control-sm constructions" style="width:100%;text-align:right;" readonly="true">
            </td>
            <td>
              <input id="id_consUF" class="form-control form-control-sm constructions" style="width:100%;text-align:right;" readonly="true">
            </td>
            <td>
              <input id="id_consVisadoUF" class="form-control form-control-sm constructions" style="width:100%;text-align:right;" readonly="true">
            </td>
            <td>
              <input id="id_consSeguroUF" class="form-control form-control-sm constructions" style="width:100%;text-align:right;" readonly="true">
            </td>
            <td style="padding:0em;text-align:right;">
              <button class="btn btn-sm save_construction" name="btn_valuation_add_construction" style="padding:0px; border:0px; display: none;">
                <i class="material-icons">save</i>
              </button>
              <button type="button" class="btn btn-sm edit_construction" value="{{con.id}}" style="padding:0px; border:0px;">
                <i class="material-icons">edit</i>
              </button>
              <button class="btn btn-sm" name="btn_valuation_remove_construction" value="{{con.id}}" style="padding:0px; border:0px;">
                <i class="material-icons">delete</i>
              </button>
            </td>
            <td></td>
          </tr>
          {% endfor %}

          <!-- This row is here to be copied when the add construction is clicked -->
          <tr id='tr_create_construction' style="display:none;">
            <input id="in_construction_id" type="hidden" name="construction_id" value="-1">
            <input id="in_construction_edited" type="hidden" name="construction_edited" value="0">
            <td></td>
            <td>
              {{forms.createConstruction.name}}
            </td>
            <td>
              {{forms.createConstruction.material}}
            </td>
            <td>
              {{forms.createConstruction.year}}
            </td>
            <td>
              {{forms.createConstruction.prenda}}
            </td>
            <td>
              {{forms.createConstruction.recepcion}}
            </td>
            <td>
              m<sup>2</sup>
            </td>
            <td>
              {{forms.createConstruction.area}}
            </td>
            <td>
              <input id="id_consPesosPerArea" class="form-control form-control-sm constructions" style="width:100%;" readonly="true">
            </td>
            <td>
              {{forms.createConstruction.UFPerArea}}
            </td>
            <td>
              <input id="id_consPesos" class="form-control form-control-sm constructions" style="width:100%;" readonly="true">
            </td>
            <td>
              <input id="id_consUF" class="form-control form-control-sm constructions" style="width:100%;" readonly="true">
            </td>
            <td>
              <input id="id_consVisadoUF" class="form-control form-control-sm constructions" style="width:100%;" readonly="true">
            </td>
            <td>
              <input id="id_consSeguroUF" class="form-control form-control-sm constructions" style="width:100%;" readonly="true">
            </td>
            <td style="padding:0em;text-align:right;">
              <button class="btn btn-sm" name="btn_valuation_add_construction" style="padding:0px; border:0px;">
                <i class="material-icons">save</i>
              </button>
            </td>
            <td></td>
          </tr>

          <!-- This row only contains the add button -->
          <tr>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
            <!--<td colspan="2"><div class="btn btn-dark btn-sm"> Agregar construcción </btn></td>-->
            <td></td>
            <td></td>
            <td style="padding:0em;text-align:right;">
              <button id="add_construction" type="button" class="btn btn-sm" name="btn_valuation_add_construction" style="padding:0px; border:0px;">
                <i class="material-icons">add_box</i>
              </button>
            </td>
            <td></td>
          </tr>

          <!-- Subtotals of constructions -->
          <tr class="table-secondary">
            <td></td>
            <td style="font-size:0.85em;">Subtotal</td>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
            <td id='id_ptotalConstArea' style="text-align:right;font-size:0.85em;"></td>
            <td id='id_ptotalConstPesosPerArea' style="text-align:right;font-size:0.85em;"></td>
            <td id='id_ptotalConstUFPerArea' style="text-align:right;font-size:0.85em;"></td>
            <td id='id_ptotalConstPesos' style="text-align:right;font-size:0.85em;"></td>
            <td id='id_ptotalConstUF' style="text-align:right;font-size:0.85em;"></td>
            <td id='id_ptotalConstVisadoUF' style="text-align:right;font-size:0.85em;"></td>
            <td id='id_ptotalConstSeguroUF' style="text-align:right;font-size:0.85em;"></td>
            <td></td>
            <td></td>
          </tr>

          <tr class="table-warning">
            <td></td>
            <td>Obras complementarias</td>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
          </tr>

          {% for ass in realestate.assets.all %}
          <tr class="tr_asset">
            <!-- Hidden inputs are used for processing the form. 
              Asset id to get if the obejct exists !-->
            <input type="hidden" name="asset_id" id="in_asset_id" value="{{ass.id}}">
            <!-- And edited, to see if we have to consider this row. See comment in view. !-->
            <input type="hidden" name="asset_edited" id="in_asset_edited" value="0">
            <td></td>
            <td id='td_name' colspan="9" style="font-size:0.85em;">
              {{ass.name}}
            </td>
            <td>
              <input id="id_assetPesos" class="form-control form-control-sm constructions" style="width:100%;text-align:right;" readonly="true">
            </td>
            <td>
              <input id="id_assetUF" class="form-control form-control-sm constructions" style="width:100%;text-align:right;" value="{{ass.value}}">
            </td>
            <td>
              <input id="id_assetVisadoUF" class="form-control form-control-sm constructions" style="width:100%;text-align:right;" readonly="true">
            </td>
            <td>
              <input id="id_assetSeguroUF" class="form-control form-control-sm constructions" style="width:100%;text-align:right;" readonly="true">
            </td>
            <td style="padding:0em;text-align:right;">
              <button class="btn btn-sm save_asset" name="btn_valuation_add_asset" style="padding:0px; border:0px; display: none;">
                <i class="material-icons">save</i>
              </button>
              <button class="btn btn-sm edit_asset" type="button" value="{{ass.id}}" style="padding:0px; border:0px;">
                <i class="material-icons">edit</i>
              </button>
              <button class="btn btn-sm" name="btn_valuation_remove_asset" value="{{ass.id}}" style="padding:0px; border:0px;">
                <i class="material-icons">delete</i>
              </button>
            </td>
            <td></td>
          </tr>
          {% endfor %}

          <!-- This row is here to be copied when the add construction is clicked -->
          <tr id='tr_create_asset' style="display:none;">
            <input id="in_asset_id" type="hidden" name="asset_id" value="-1">
            <input id="in_asset_edited" type="hidden" name="asset_edited" value="0">
            <td></td>
            <td colspan="9">
              {{forms.createAsset.name}}
            </td>
            <td>
              <input id="id_assetPesos" class="form-control form-control-sm constructions" style="width:100%;" readonly="true">
            </td>
            <td>
              {{forms.createAsset.value}}
            </td>
            <td>
              <input id="id_assetVisadoUF" class="form-control form-control-sm constructions" style="width:100%;" readonly="true">
            </td>
            <td>
              <input id="id_assetSeguroUF" class="form-control form-control-sm constructions" style="width:100%;" readonly="true">
            </td>
            <td style="padding:0em;text-align:right;">
              <button class="btn btn-sm" name="btn_valuation_add_asset" style="padding:0px; border:0px;">
                <i class="material-icons">save</i>
              </button>
            </td>
            <td></td>
          </tr>

          <!-- This row only contains the add button -->
          <tr>
            <td></td>
            <td colspan="14" style="padding:0em;text-align:right;">
              <button id="add_asset" type="button" class="btn btn-sm" name="btn_valuation_add_asset" style="padding:0px; border:0px;">
                <i class="material-icons">add_box</i>
              </button>
            </td>
            <td></td>
          </tr>

          <tr class="table-secondary">
            <td></td>
            <td style="font-size:0.85em;">Subtotal</td>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
            <td id='id_ptotalAssetsPesos' style="text-align:right;font-size:0.85em;">1</td>
            <td id='id_ptotalAssetsUF' style="text-align:right;font-size:0.85em;">2</td>
            <td id='id_ptotalAssetsVisadoUF' style="text-align:right;font-size:0.85em;">3</td>
            <td id='id_ptotalAssetsSeguroUF' style="text-align:right;font-size:0.85em;">4</td>
            <td></td>
            <td></td>
          </tr>

          <!-- Grand total -->

          <tr class="table-primary" style="border:2px solid #000;">
            <td></td>
            <td colspan="9" style="text-align:right;padding-right:3em;">Valor comercial tasador</td>
            <td id='id_totalPesos' style="text-align:right;"></td>
            <td id='id_totalUF' style="text-align:right;"></td>
            <td id='id_totalVisadoUF' style="text-align:right;"></td>
            <td id='id_totalSeguroUF' style="text-align:right;"></td>
            <td></td>
            <td></td>
          </tr>
        </tbody>
      </table>

    </div>
  </div>
</div>

</div>

<script>

  var UF_IN_PESOS = 0.0;

  function pesosFormat(number) {
    if (typeof number === 'string') {
      number = number.trim()
      if (number.length > 0) {
        if (isNaN(parseFloat(number))) return '-'
        return parseFloat(number).toLocaleString('es',{maximumFractionDigits:0});
      } else {
        return '-'
      }
    } else {
      return number.toLocaleString('es',{maximumFractionDigits:0});
    }
  }
  function UFFormat(number) {
    if (typeof number === 'string') {
      number = number.trim()
      if (number.length > 0) {
        if (isNaN(parseFloat(number))) return '-'
        return parseFloat(number).toLocaleString('es',{maximumFractionDigits:1,minimumFractionDigits:1}); 
      } else {
        return '-'
      }
    } else {
      return number.toLocaleString('es',{maximumFractionDigits:1,minimumFractionDigits:1}); 
    }
  }
  function percentFormat(number) {
    if (typeof number === 'string') {
      number = number.trim()
      if (number.length > 0) {
        if (isNaN(parseFloat(number))) return '-'
        return parseFloat(number).toLocaleString('es',{style:'percent',maximumFractionDigits:1}); 
      } else {
        return '-'
      }
    } else {
      return number.toLocaleString('es',{style:'percent',maximumFractionDigits:1}); 
    }
  }
  function areaFormat(number) {
    if (typeof number === 'string') {
      number = number.trim()
      console.log(number)
      if (number.length > 0) {
        if (isNaN(parseFloat(number))) return '-'
        return parseFloat(number).toLocaleString('es',{maximumFractionDigits:1,minimumFractionDigits:1}); 
      } else {
        return '-'
      }
    } else {
      return number.toLocaleString('es',{maximumFractionDigits:1,minimumFractionDigits:1}); 
    }
  }
  function floatFormat(number) {
    if (typeof number === 'string') {
      number = number.trim()
      if (number.length > 0) {
        if (isNaN(parseFloat(number))) return '-'
        return parseFloat(number).toLocaleString('es',{maximumFractionDigits:1,minimumFractionDigits:1}); 
      } else {
        return '-'
      }
    } else {
      return number.toLocaleString('es',{maximumFractionDigits:1 ,minimumFractionDigits:1}); 
    }
  }
  function parseFloatEs(string) {
    console.log('parseFloatEs',string)
    string = string.replace(/[.]+/g,'')
    string = string.replace(/[,]+/g,'.')
    console.log('parseFloatEs',string)
    return parseFloat(string)
  }

  function formatNumbers() {
    var valorUF = parseFloat($("#id_valorUF").val());
    $("#id_valorUF").val(UFFormat(valorUF));
  }

  function computeValues() {
    // Main valuation prices
    var valorUF = parseFloatEs($("#id_valorUF").val());
    var liquidez = parseFloatEs($("#liquidity").val());
    var seguroUF = parseFloatEs($("#id_totalSeguroUF").text());
    if (!isNaN(valorUF)) {
      $("liquidity").val(floatFormat(liquidez))
      $("#id_valorUF").val(UFFormat(valorUF));
      $("#in_value_market").val(pesosFormat(valorUF*UF_IN_PESOS));
      $("#in_value_liquid_UF").val(UFFormat(valorUF*liquidez));
      $("#in_value_liquid").val(pesosFormat(valorUF*liquidez*UF_IN_PESOS));
      $("#in_value_safe_UF").val(UFFormat(seguroUF));
      $("#in_value_safe").val(pesosFormat(seguroUF*UF_IN_PESOS));
    } else {
      $("#in_value_market").val('');
      $("#in_value_liquid_UF").val('');
      $("#in_value_liquid").val('');
      $("#in_value_safe_UF").val('');
      $("#in_value_safe").val('');
    }
    // Update valuation prince in rows of tables of current real estate
    var builtSquareMeters  = {{realestate.house.builtSquareMeters}}
    var totalSquareMeters  = {{realestate.total_area}}
    var house = {{realestate.is_house}}
    console.log(house)
    $(".td_cre_market_price").text(UFFormat(valorUF))
    if ({{realestate.is_house}}) {
      $(".td_cre_market_price_per_built_square_meters").text(UFFormat(valorUF/builtSquareMeters))
      $(".td_cre_market_price_per_total_square_meters").text(UFFormat(valorUF/totalSquareMeters))
    }
    // Rent prices
    var months = 11
    var rate = 0.06
    var area = 10.0
    $("#id_value_rent_months").val(months)
    $("#id_value_rent_rate").val(percentFormat(rate))
    if (!isNaN(valorUF)) {
      $("#id_value_rent_month").val(UFFormat(valorUF*0.005))
      var value_rent_month = valorUF*0.005
      $("#id_value_rent_year").val(UFFormat(value_rent_month*months))
      $("#id_value_rent_per_area").val(UFFormat(rate*area))
      $("#id_value_rent").val(UFFormat(value_rent_month*months/rate))
    } else {
      $("#id_value_rent_month").val('');
      $("#id_value_rent_year").val('');
      $("#id_value_rent_per_area").val('');
      $("#id_value_rent").val('');
    }
  }

  $("#id_valorUF").change(function () {
    computeValues();
  });

  $("#liquidity").change(function () {
    computeValues()
  });

  $("#id_valorUF").focus(function () {
    computeValues()
  });

  $("#id_valorUF").focusout(function () {
    computeValues()
  });

  function remove(val) {
    /*
    Remove the row from the valuation list.
    Add the button to add row in MarketList, if it is there.
    */
    row_valuation = $('#trValuationRealEstate_'+val);
    row_valuation.find('#in_valuationRealEstateRemove').attr('value',1)
    row_valuation.toggle();
    row_market = $('#trMarketRealEstate_'+val);
    row_market.find('.btn').show();
    row_market.removeClass('table-success');
    averagesValuationRealEstate();
  }

  function averagesValuationRealEstate() {
    var sumUsefulSquareMeters = 0
    var sumTerraceSquareMeters = 0
    var sumMarketPrice = 0
    var c = 0
    $('#tableValuationRealEstate tr').each(function() {
      str = parseFloat($(this).find(".tdUsefulSquareMeters").text());
      if (!isNaN(str)) {
        sumUsefulSquareMeters += parseFloat($(this).find(".tdUsefulSquareMeters").text());
        c += 1
      }
      str = parseFloat($(this).find(".tdTerraceSquareMeters").text());
      if (!isNaN(str)) {
        sumTerraceSquareMeters += parseFloat($(this).find(".tdTerraceSquareMeters").text());
      }
      str = parseFloat($(this).find(".tdMarketPrice").text());
      if (!isNaN(str)) {
        sumMarketPrice += parseFloat($(this).find(".tdMarketPrice").text());
      }
    });
    if (c == 0) {
      $('#vreUsefulSquareMetersAvg').text('-')
      $('#vreTerraceSquareMetersAvg').text('-')
      $('#vreMarketPriceAvg').text('-')
      $('#vreMarketPricePerUsefulSquareMetersAvg').text('-')
      $('#vreMarketPricePerTotalSquareMetersAvg').text('-')
    } else {
      var avgUsefulSquareMeters = sumUsefulSquareMeters/c;
      var avgTerraceSquareMeters = sumTerraceSquareMeters/c;
      var avgMarketPrice = sumMarketPrice/c;
      $('#vreUsefulSquareMetersAvg').text((avgUsefulSquareMeters).toFixed(2))
      $('#vreTerraceSquareMetersAvg').text((avgTerraceSquareMeters).toFixed(2))
      $('#vreMarketPriceAvg').text((avgMarketPrice).toFixed(2))
      $('#vreMarketPricePerUsefulSquareMetersAvg').text((avgMarketPrice/avgUsefulSquareMeters).toFixed(2))
      $('#vreMarketPricePerTotalSquareMetersAvg').text((avgMarketPrice/(avgUsefulSquareMeters+avgTerraceSquareMeters)).toFixed(2))
    }
  }

  function assetsTableComputeTotalsTerrains() {
    var sumArea = 0
    var sumPesosPerArea = 0
    var sumUFPerArea = 0
    var sumPesos = 0
    var sumUF = 0
    var sumVisadoUF = 0
    var sumSeguroUF = 0
    var c = 0
    $('#table_constructions tr').each(function() {
      console.log($(this))
      if (!($(this).hasClass('tr_terrain'))) return
      if ($(this).attr('id') == 'id_input') return
      if ($(this).attr('id') == 'tr_create_terrain') return
      area = parseFloat($(this).find("#id_terrainArea").val());
      if (!isNaN(area)) {
        sumArea += area;
        c += 1
      }
      pesosPerArea = parseFloat($(this).find("#id_terrainPesosPerArea").val());
      if (!isNaN(pesosPerArea)) {
        sumPesosPerArea += pesosPerArea;
      }
      UFPerArea = parseFloat($(this).find("#id_terrainUFPerArea").val());
      if (!isNaN(UFPerArea)) {
        sumUFPerArea += UFPerArea;
      }
      pesos = parseFloat($(this).find("#id_terrainPesos").val());
      if (!isNaN(pesos)) {
        sumPesos += pesos;
      }
      UF = parseFloat($(this).find("#id_terrainUF").val());
      if (!isNaN(UF)) {
        sumUF += UF;
      }
      visadoUF = parseFloat($(this).find("#id_terrainVisadoUF").val());
      if (!isNaN(visadoUF)) {
        sumVisadoUF += visadoUF;
      }
      seguroUF = parseFloat($(this).find("#id_terrainSeguroUF").val());
      if (!isNaN(seguroUF)) {
        sumSeguroUF += seguroUF;
      }
    });
    if (c == 0) {
      $('#id_ptotalTerrArea').text('-')
      $('#id_ptotalTerrPesosPerArea').text('-')
      $('#id_ptotalTerrUFPerArea').text('-')
      $('#id_ptotalTerrPesos').text('-')
      $('#id_ptotalTerrUF').text('-')
      $('#id_ptotalTerrVisadoUF').text('-')
      $('#id_totalPesos').text('-')
      $('#id_totalUF').text('-')
      $('#id_totalVisadoUF').text('-')
      $('#id_totalSeguroUF').text('-')
    } else {
      var avgArea = sumArea/c;
      var avgPesosPerArea = sumPesosPerArea/c;
      var avgUFPerArea = sumUFPerArea/c;
      var avgPesos = sumPesos/c;
      var avgUF = sumUF/c;
      var avgVisadoUF = sumVisadoUF/c;
      var avgSeguroUF = sumSeguroUF/c;
      $('#id_ptotalTerrArea').text(areaFormat(sumArea))
      $('#id_ptotalTerrPesosPerArea').text(pesosFormat(sumPesos/sumArea))
      $('#id_ptotalTerrUFPerArea').text(UFFormat(sumUF/sumArea))
      $('#id_ptotalTerrPesos').text(pesosFormat(sumPesos))
      $('#id_ptotalTerrUF').text(UFFormat(sumUF))
      $('#id_ptotalTerrVisadoUF').text(UFFormat(sumVisadoUF))
    }
  }

  function assetsTableComputeTotalsConstructions() {
    var sumArea = 0
    var sumPesosPerArea = 0
    var sumUFPerArea = 0
    var sumPesos = 0
    var sumUF = 0
    var sumVisadoUF = 0
    var sumSeguroUF = 0
    var c = 0
    $('#table_constructions tr').each(function() {
      if (!($(this).hasClass('tr_construction'))) return
      if ($(this).attr('id') == 'id_input') return
      if ($(this).attr('id') == 'tr_create_construction') return
      area = parseFloat($(this).find("#id_consArea").val());
      if (!isNaN(area)) {
        sumArea += area;
        c += 1
      }
      pesosPerArea = parseFloat($(this).find("#id_consPesosPerArea").val());
      if (!isNaN(pesosPerArea)) {
        sumPesosPerArea += pesosPerArea;
      }
      UFPerArea = parseFloat($(this).find("#id_consUFPerArea").val());
      if (!isNaN(UFPerArea)) {
        sumUFPerArea += UFPerArea;
      }
      pesos = parseFloat($(this).find("#id_consPesos").val());
      if (!isNaN(pesos)) {
        sumPesos += pesos;
      }
      UF = parseFloat($(this).find("#id_consUF").val());
      if (!isNaN(UF)) {
        sumUF += UF;
      }
      visadoUF = parseFloat($(this).find("#id_consVisadoUF").val());
      if (!isNaN(visadoUF)) {
        sumVisadoUF += visadoUF;
      }
      seguroUF = parseFloat($(this).find("#id_consSeguroUF").val());
      if (!isNaN(seguroUF)) {
        sumSeguroUF += seguroUF;
      }
    });
    if (c == 0) {
      $('#id_ptotalConstArea').text('-')
      $('#id_ptotalConstPesosPerArea').text('-')
      $('#id_ptotalConstUFPerArea').text('-')
      $('#id_ptotalConstPesos').text('-')
      $('#id_ptotalConstUF').text('-')
      $('#id_ptotalConstVisadoUF').text('-')
      $('#id_ptotalConstSeguroUF').text('-')
    } else {
      var avgArea = sumArea/c;
      var avgPesosPerArea = sumPesosPerArea/c;
      var avgUFPerArea = sumUFPerArea/c;
      var avgPesos = sumPesos/c;
      var avgUF = sumUF/c;
      var avgVisadoUF = sumVisadoUF/c;
      var avgSeguroUF = sumSeguroUF/c;
      $('#id_ptotalConstArea').text(areaFormat(sumArea))
      $('#id_ptotalConstPesosPerArea').text(pesosFormat(sumPesos/sumArea))
      $('#id_ptotalConstUFPerArea').text(UFFormat(sumUF/sumArea))
      $('#id_ptotalConstPesos').text(pesosFormat(sumPesos))
      $('#id_ptotalConstUF').text(UFFormat(sumUF))
      $('#id_ptotalConstVisadoUF').text(UFFormat(sumVisadoUF))
      $('#id_ptotalConstSeguroUF').text(UFFormat(sumSeguroUF))
    }
  }


  function assetsTableComputeTotalsAssets() {
    var sumPesos = 0
    var sumUF = 0
    var sumVisadoUF = 0
    var sumSeguroUF = 0
    var c = 0
    $('#table_constructions tr').each(function() {
      if (!($(this).hasClass('tr_asset'))) return
      if ($(this).attr('id') == 'id_input') return
      if ($(this).attr('id') == 'tr_create_asset') return
      pesos = parseFloat($(this).find("#id_assetPesos").val());
      if (!isNaN(pesos)) {
        sumPesos += pesos;
      }
      UF = parseFloat($(this).find("#id_assetUF").val());
      console.log(UF)
      if (!isNaN(UF)) {
        sumUF += UF;
        c += 1;
      }
      visadoUF = parseFloat($(this).find("#id_assetVisadoUF").val());
      if (!isNaN(visadoUF)) {
        sumVisadoUF += visadoUF;
      }
      seguroUF = parseFloat($(this).find("#id_assetSeguroUF").val());
      if (!isNaN(seguroUF)) {
        sumSeguroUF += seguroUF;
      }
    });
    if (c == 0) {
      $('#id_ptotalAssetsPesos').text('-')
      $('#id_ptotalAssetsUF').text('-')
      $('#id_ptotalAssetsVisadoUF').text('-')
      $('#id_ptotalAssetsSeguroUF').text('-')
    } else {
      var avgPesos = sumPesos/c;
      var avgUF = sumUF/c;
      var avgVisadoUF = sumVisadoUF/c;
      var avgSeguroUF = sumSeguroUF/c;
      $('#id_ptotalAssetsPesos').text(pesosFormat(sumPesos))
      $('#id_ptotalAssetsUF').text(UFFormat(sumUF))
      $('#id_ptotalAssetsVisadoUF').text(UFFormat(sumVisadoUF))
      $('#id_ptotalAssetsSeguroUF').text(UFFormat(sumSeguroUF))
    }
  }

  function assetsTableComputeTotalsGlobal() {
    var sumPesos = 0
    sumPesos += parseFloatEs($('#id_ptotalTerrPesos').text().trim());
    sumPesos += parseFloatEs($('#id_ptotalConstPesos').text().trim());
    sumPesos += parseFloatEs($('#id_ptotalAssetsPesos').text().trim());

    var sumUF = 0
    sumUF += parseFloatEs($('#id_ptotalTerrUF').text().trim());
    sumUF += parseFloatEs($('#id_ptotalConstUF').text().trim());
    sumUF += parseFloatEs($('#id_ptotalAssetsUF').text().trim());

    var sumVisadoUF = 0
    sumVisadoUF += parseFloatEs($('#id_ptotalTerrVisadoUF').text().trim());
    sumVisadoUF += parseFloatEs($('#id_ptotalConstVisadoUF').text().trim());
    sumVisadoUF += parseFloatEs($('#id_ptotalAssetsVisadoUF').text().trim());

    var sumSeguroUF = 0
    sumSeguroUF += parseFloatEs($('#id_ptotalConstSeguroUF').text().trim());
    sumSeguroUF += parseFloatEs($('#id_ptotalAssetsSeguroUF').text().trim());

    $('#id_totalPesos').text(pesosFormat(sumPesos))
    $('#id_totalUF').text(UFFormat(sumUF))
    $('#id_totalVisadoUF').text(UFFormat(sumVisadoUF))
    $('#id_totalSeguroUF').text(UFFormat(sumSeguroUF))
  }

  function assetsTableComputeTotals() {
    assetsTableComputeTotalsTerrains();
    assetsTableComputeTotalsConstructions();
    assetsTableComputeTotalsAssets();
    assetsTableComputeTotalsGlobal();
  }

  function assetsTableUpdateRows() {
    $('#table_constructions tr').each(function() {
      if ($(this).hasClass('tr_terrain')) {
        uf = UF_IN_PESOS;
        area = parseFloat($(this).find("#id_terrainArea").val());
        UFPerArea = parseFloat($(this).find("#id_terrainUFPerArea").val());
        console.log('UFPerArea',UFPerArea)
        $(this).find('#id_terrainPesosPerArea').val(parseInt(UFPerArea*uf));
        $(this).find('#id_terrainPesos').val(parseInt(UFPerArea*uf*area));
        $(this).find('#id_terrainUF').val(parseInt(UFPerArea*area));
        $(this).find('#id_terrainVisadoUF').val(parseInt(UFPerArea*area));
        $(this).find('#id_terrainSeguroUF').val(parseInt(UFPerArea*area));
      }
      if ($(this).hasClass('tr_construction')) {
        uf = UF_IN_PESOS;
        area = parseFloat($(this).find("#id_consArea").val());
        UFPerArea = parseFloat($(this).find("#id_consUFPerArea").val());
        $(this).find('#id_consPesosPerArea').val(parseInt(UFPerArea*uf));
        $(this).find('#id_consPesos').val(parseInt(UFPerArea*uf*area));
        $(this).find('#id_consUF').val(parseInt(UFPerArea*area));
        $(this).find('#id_consVisadoUF').val(parseInt(UFPerArea*area));
        $(this).find('#id_consSeguroUF').val(parseInt(UFPerArea*area));
      }
      if ($(this).hasClass('tr_asset')) {
        uf = UF_IN_PESOS;
        UF = parseFloat($(this).find("#id_assetUF").val());
        $(this).find('#id_assetPesos').val(parseInt(uf*UF));
        $(this).find('#id_assetVisadoUF').val(parseInt(UF));
        $(this).find('#id_assetSeguroUF').val(parseInt(UF));
      }
    });
  }

  $(".constructions").change(function () {
    assetsTableUpdateRows();
    assetsTableComputeTotals();
  });

  function computeMarketRealEstate() {
    $('#tableMarketRealEstate tr').each(function() {
      $(this).find('.tdMarketPrice').html(function() {
        return UFFormat($(this).html())
      });
      $(this).find('.tdUsefulSquareMeters').html(function() {
        return areaFormat($(this).html())
      });
      $(this).find('.tdTerraceSquareMeters').html(function() {
        return areaFormat($(this).html())
      });
      $(this).find('.tdMarketPricePerUsefulSquareMeters').html(function() {
        return floatFormat($(this).html())
      })
      $(this).find('.tdMarketPricePerTotalSquareMeters').html(function() {
        return floatFormat($(this).html())
      });
    });
  }
 
  $(document).ready(function() {

    formatNumbers();

    $.getJSON('https://mindicador.cl/api', function(data) {
      UF_IN_PESOS = data.uf.valor
      assetsTableUpdateRows();
      computeValues();

      assetsTableComputeTotals();

      }).fail(function() {
        console.log('Error al consumir la API!');
      }
    );

    var propertyType = {{realestate.propertyType}}
    $("#id_vc-propertyType").val(propertyType);

    averagesValuationRealEstate();
    computeMarketRealEstate();

    assetsTableComputeTotals();

    $('.edit_construction').click(function() {
      row = $(this).closest('tr')

      input = row.find('#in_construction_edited')
      input.val('1')

      btn = row.find('.save_construction')
      btn.toggle()

      cell = row.find('#td_name')
      text = cell.text()
      cell.empty()
      cell.append('{{forms.createConstruction.name}}')
      cell.find('#id_c-name').val(text.trim())

      cell = row.find('#td_material')
      text = cell.text()
      cell.empty()
      cell.append('{{forms.createConstruction.material|escapejs}}')
      cell.find('#id_c-material option').filter(function() {
        return $(this).text() == text.trim(); 
      }).prop('selected', true);

      cell = row.find('#td_year')
      text = cell.text()
      cell.empty()
      cell.append('{{forms.createConstruction.year|escapejs}}')
      cell.find('#id_c-year').val(text.trim())

      cell = row.find('#td_prenda')
      text = cell.text()
      cell.empty()
      cell.append('{{forms.createConstruction.prenda|escapejs}}')
      cell.find('#id_c-prenda option').filter(function() {
        return $(this).text() == text; 
      }).prop('selected', true);

      cell = row.find('#td_recepcion')
      text = cell.text()
      cell.empty()
      cell.append('{{forms.createConstruction.recepcion|escapejs}}')
      cell.find('#id_c-recepcion option').filter(function() {
        return $(this).text() == text; 
      }).prop('selected', true);

      $(this).toggle()
    });

    $('.edit_terrain').click(function() {
      row = $(this).closest('tr')

      // Set hidden input value to 1, so that when saving know this row was editted
      input = row.find('#in_terrain_edited')
      input.val('1')

      // Turn on the save button
      btn = row.find('.save_terrain')
      btn.toggle()

      // Turn off button to edit.
      $(this).toggle()

      // Change row from text to input.
      cell = row.find('#td_name')
      text = cell.text()
      cell.empty()
      cell.append('{{forms.createTerrain.name}}')
      cell.find('#id_t-name').val(text.trim())

    });

    $('.removeValuationRealEstate').click(function() {
      var rid = $(this).val();
      remove(rid);
    });

    $('#add_terrain').click(function() {
      var newRow = $('#tr_create_terrain').clone();
      $('#tr_create_terrain').before(newRow)
      newRow.attr('id','')
      newRow.toggle();
      newRow.find('#in_terrain_edited').val('1')
    });

    $('#add_construction').click(function() {
      var newRow = $('#tr_create_construction').clone();
      $('#tr_create_construction').before(newRow)
      newRow.attr('id','')
      newRow.toggle();
      newRow.find('#in_construction_edited').val('1')
    });

    $('#add_asset').click(function() {
      var newRow = $('#tr_create_asset').clone();
      $('#tr_create_asset').before(newRow)
      newRow.attr('id','')
      newRow.toggle();
      newRow.find('#in_asset_edited').val('1')
    });

    $('#add_construction_comp').click(function() {
      var newRow = $('#tr_create_construction_comp').clone();
      //$(this).closest('tr').before(newRow)
      $('#tr_create_construction_comp').before(newRow)
      newRow.attr('id','')
      newRow.toggle();
      newRow.find('#in_construction_edited').val('1')
    });

    $('.add').click(function() {
      var rid = $(this).val();
      var row = $(this).closest('tr');
      row.addClass('table-success');
      
      // Create row to be added to valuation real estate list
      var newRow = row.clone();
      var rowCount = $('#tableValuationRealEstate tr').length-4+1; // minus heading and current, +1 for count
      var btn = newRow.find('.add')
      btn.removeClass('add')
      btn.addClass('remove')
      btn.empty()
      btn.append('<i class="material-icons">delete</i>')
      btn.attr("value",rid)
      // Input, needed when saving
      var hiddenInput1 = '<input name="valuationRealEstateRow" type="hidden" value="'+rid+'">'
      var hiddenInput2 = '<input name="valuationRealEstateRemove" type="hidden" value="0">'
      $('#tableValuationRealEstate > tbody > tr').eq(rowCount-1).after('<tr id="trValuationRealEstate_'+rid+'">'+
        hiddenInput1+
        hiddenInput2+
        newRow.html()+'</tr>');
      // Add event handler to button created in new row
      $('.remove').click(function(){
        var rid = $(this).val();
        remove(rid);
      })

      // Modify clicked row to remove the add button
      btn = row.find('.btn')
      btn.hide()
      
      // Recompute the averages
      averages();
    });

    assetsTableUpdateRows();
    assetsTableComputeTotals();

  });
</script>

