
<form id="form_appraisal">
{% csrf_token %}
<div id="appraisal_data" data-appraisal_id={{appraisal.id}}>
</div>
<div class="row ml-4 mt-5 mr-4 mb-4">
<div class="col">

  <div class="row">
    <div class="col-2">
    </div>
    <div class="col-4">
      <div class="form-group">
        <label>Tasador</label>
        <input type="text" class="form-control" value="{{forms.appraisal.instance.tasadorUser.first_name}} {{forms.appraisal.instance.tasadorUser.last_name}}" disabled>
      </div>
    </div>
    <div class="col-auto">
      <div class="form-group">
        {% if perms.appraisal.assign_tasador %}
        {% if appraisal.active %}
        <button type="button" class="btn btn-secondary btn_assign_tasador_modal" value="{{appraisal.id}}" style="margin-top:2em;">
          Asignar tasador
        </button>
        {% endif %}
        {% endif %}
      </div>
    </div>
  </div>

  <div class="row">
    <div class="col-2">
    </div>
    <div class="col-4">
      <div class="form-group">
        <label>Visador</label>
        <input type="text" class="form-control" value="{{forms.appraisal.instance.visadorUser.first_name}} {{forms.appraisal.instance.visadorUser.last_name}}" disabled>
      </div>
    </div>
    <div class="col-auto">
      <div class="form-group">
        {% if perms.appraisal.assign_visador %}
        {% if appraisal.active %}
        <button type="button" class="btn btn-secondary" data-toggle="modal" data-target="#asignarVisador" style="margin-top:2em;">
          Asignar visador
        </button>
        {% endif %}
        {% endif %}
      </div>
    </div>
  </div>

  <hr/>

  <div class="row">
    <div class="col-2">
      <p class="font-weight-bold text-right">Tasaci칩n</p>
    </div>
    <div class="col-2">
      <div class="form-group">
        <label>Tipo</label>
        {{forms.appraisal.tipoTasacion}}
      </div>
    </div>
    <div class="col-2">
      <div class="form-group">
        <label>Finalidad</label>
        {{forms.appraisal.finalidad}}
      </div>
    </div>
    <div class="col-2">
      <div class="form-group">
        <label>Visita</label>
        {{forms.appraisal.visita}}
      </div>
    </div>
  </div>

  <hr/>

  <div class="row">
    <div class="col-2">
      <p class="font-weight-bold text-right">Solicitante</p>
    </div>
    <div class="col-2">
      <div class="form-group">
        <label>Instituci칩n</label>
        {{forms.appraisal.solicitante}}
      </div>
    </div>
    <div class="col-2">
      <div class="form-group">
        <label>Sucursal</label>
        {{forms.appraisal.solicitanteSucursal}}
      </div>
    </div>
    <div class="col-2">
      <div class="form-group">
        <label>C칩digo</label>
        {{forms.appraisal.solicitanteCodigo}}
      </div>
    </div>
  </div>

  <div class="row">
    <div class="col-2">
      <p class="font-weight-bold text-right">Ejecutivo</p>
    </div>
    <div class="col-4">
      <div class="form-group">
        <label>Nombre</label>
        {{forms.appraisal.solicitanteEjecutivo}}
      </div>
    </div>
  </div>
  <div class="row">
    <div class="col-2">
    </div>
    <div class="col-4">
      <div class="form-group">
        <label>Email</label>
        {{forms.appraisal.solicitanteEjecutivoEmail}}
      </div>
    </div>
    <div class="col-2">
      <div class="form-group">
        <label>Telefono</label>
        {{forms.appraisal.solicitanteEjecutivoTelefono}}
      </div>
    </div>
  </div>

  <hr/>

  <div class="row">
    <div class="col-2">
      <p class="font-weight-bold text-right">Cliente</p>
    </div>
    <div class="col-4">
      <div class="form-group">
        <label>Nombre</label>
        {{forms.appraisal.cliente}}
      </div>
    </div>
    <div class="col-2">
      <div class="form-group">
        <label>Rut</label>
        {{forms.appraisal.clienteRut}}
      </div>
    </div>
  </div>
  <div class="row">
    <div class="col-2">
    </div>
    <div class="col-4">
      <div class="form-group">
        <label>Email</label>
        {{forms.appraisal.clienteEmail}}
      </div>
    </div>
    <div class="col-2">
      <div class="form-group">
        <label>Telefono</label>
        {{forms.appraisal.clienteTelefono}}
      </div>
    </div>
  </div>

  <hr/>

  <div class="row mt">
    <div class="col-2">
      <p class="font-weight-bold text-right">Contacto</p>
    </div>
    <div class="col-4">
      <div class="form-group">
        <label>Nombre</label>
        {{forms.appraisal.contacto}}
      </div>
    </div>
    <div class="col-2">
      <div class="form-group">
        <label>Rut</label>
        {{forms.appraisal.contactoRut}}
      </div>
    </div>
  </div>
  <div class="row mt">
    <div class="col-2">
    </div>
    <div class="col-4">
      <div class="form-group">
        <label>Email</label>
        {{forms.appraisal.contactoEmail}}
      </div>
    </div>
    <div class="col-2">
      <div class="form-group">
        <label>Telefono</label>
        {{forms.appraisal.contactoTelefono}}
      </div>
    </div>
  </div>

  <hr/>

  <div class="row mt">
    <div class="col-2">
      <p class="font-weight-bold text-right">Propietario</p>
    </div>
    <div class="col-4">
      <div class="form-group">
        <label>Nombre</label>
        {{forms.appraisal.propietario}}
      </div>
    </div>
    <div class="col-2">
      <div class="form-group">
        <label>Rut</label>
        {{forms.appraisal.propietarioRut}}
      </div>
    </div>
  </div>
  <div class="row mt">
    <div class="col-2">
    </div>
    <div class="col-4">
      <div class="form-group">
        <label>Email</label>
        {{forms.appraisal.propietarioEmail}}
      </div>
    </div>
    <div class="col-2">
      <div class="form-group">
        <label>Telefono</label>
        {{forms.appraisal.propietarioTelefono}}
      </div>
    </div>
  </div>

</div>
</div>
</form>

<script>

  function valid_rut(rut) {
    function dv(T) {
      var M=0,S=1;
      for (;T;T=Math.floor(T/10)) {
        S=(S+T%10*(9-M++%6))%11;
      }
      return S?S-1:'k';
    };
    if (rut.length < 2) return false
    rut = rut.split('.').join("");
    rut = rut.split('-').join("");
    var digv = rut.charAt(rut.length-1);
    n = rut.substring(0,rut.length-1)
    return (dv(n) == digv);
    rut = parseInt(rut);
    if (isNaN(rut)) {
      return false
    }
    return true
  }
  
  jQuery.validator.addMethod("rut",
    function(value, element) {
      return this.optional(element) || valid_rut(value);
    },
    "El rut no es v치lido"
  );

  $("#form").validate({
    rules: {
      "clienteRut": "rut",
      "propietarioRut": "rut"
    },
    errorPlacement: function(error, element) {
      error.insertAfter(element);
    }
  });

  function save_appraisal() {
    var form = $('#form_appraisal')
    data = join_data(form,$("#appraisal_data"))
    url = "{% url 'ajax_save_appraisal_url' %}"
    $.ajax({
      url: url,
      type: 'post',
      data: $.param(data),
      //async: false,
      error: function () {
        alert("Error al grabar.");
        return false;
      },
      success: function (data) {
        return true;
      }
    });
  }

</script>
