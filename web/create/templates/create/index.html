{% extends "main/base.html" %}

{% load static %}

{% block content %}

<div class="container" style="max-width:100%">

   <div class="row">
      <div class="col-md-2">
      </div>
      <div class="col-md-10">
         <h5 class="mb-4">Ingresar tasación</h5>
      </div>
   </div>

    <form class="needs-validation" action="/create/" method="post" id="form" enctype="multipart/form-data"
      data-commune-url="{% url 'ajax_load_communes' %}" data-populate-from-file-url="{% url 'ajax_populate_from_file' %}" novalidate>
        {% csrf_token %}

        <div class="row">
          <div class="col-md-2 text-right">
            <p class="font-weight-bold">Solicitud</p>
          </div>
          <div class="col-md-5">
            <div class="form-group">
              <div class="custom-file">
                {{form.archivo}}
                <label class="custom-file-label" for="validatedCustomFile">Seleccionar archivo</label>
              </div>
            </div>
          </div>
          <div class="col-1">
            <button id="populate" class="btn btn-primary ld-ext-right">
              Importar
              <div class="ld ld-ring ld-spin"></div>
            </button>
          </div>
        </div>

        <script>
          $('#id_archivo').change(function() {
            if ($('#id_archivo')[0].files.length == 1) {
              var file = $('#id_archivo')[0].files[0].name;
              $('.custom-file-label').text(file);
            } else {
              $('.custom-file-label').text('Múltiples archivos');
            }
          });
        </script>

        <div class="row">
          <div class="col-md-2 text-right">
            <p class="font-weight-bold"></p>
          </div>
          <div class="col-md-6">
            <div class="alert alert-warning" role="alert" id="id_import_alert" style="display:none;">
            </div>
          </div>
        </div>

        <div class="row">
          <div class="col-md-2 text-right">
          </div>
            <div class="col-md-2" id="petitioner">
               <div class="form-group">
                  <label>Institución</label>
                  {{form.solicitante}}
               </div>
            </div>
            <div class="col-md-2" id="other" hidden>
               <div class="form-group">
                  {{form.solicitanteOther.label_tag}}
                  {{form.solicitanteOther}}
               </div>
            </div>
            <div class="col-md-2">
               <div class="form-group" id="code">
                  <label>Sucursal</label>
                  {{form.solicitanteSucursal}}
               </div>
            </div>
            <div class="col-md-2">
               <div class="form-group" id="code">
                  <label>Código</label>
                  {{form.solicitanteCodigo}}
               </div>
            </div>

        </div>

        <div class="row">
          <div class="col-md-2 text-right">
          </div>
          <div class="col-md-4" id="petitioner">
            <div class="form-group">
              <label>Ejecutivo</label>
              {{form.solicitanteEjecutivo}}
            </div>
          </div>
        </div>

        <div class="row">
          <div class="col-md-2 text-right">
          </div>
          <div class="col-md-4" id="petitioner">
            <div class="form-group">
              <label>Email</label>
              {{form.solicitanteEjecutivoEmail}}
            </div>
          </div>
          <div class="col-md-2" id="petitioner">
            <div class="form-group">
              <label>Teléfono</label>
              {{form.solicitanteEjecutivoTelefono}}
            </div>
          </div>
        </div>

        <div class="row">
          <div class="col-md-2">
          </div>
          <div class="col-md-3">
            <div class="form-group">
              {{form.appraisalTimeRequest.label_tag}}
              <div class="input-group date" id="datetimepicker1" data-target-input="nearest">
                {{form.appraisalTimeRequest}}
                <div class="input-group-append" data-target="#datetimepicker1" data-toggle="datetimepicker">
                  <div class="input-group-text"><i class="fa fa-calendar"></i></div>
                </div>
              </div>
            </div>
          </div>
          <script type="text/javascript">
            $(function () {
              $('#datetimepicker1').datetimepicker({
                locale: 'es',
                icons: {
                  time: "far fa-clock",
                  date: "far fa-calendar-alt",
                  up: "fas fa-arrow-up",
                  down: "fas fa-arrow-down"
                }
              });
            });
          </script>

          <div class="col-md-3">
            <div class="form-group">
              {{form.appraisalTimeDue.label_tag}}
              <div class="input-group date" id="datetimepicker2" data-target-input="nearest">
                {{form.appraisalTimeDue}}
                <div class="input-group-append" data-target="#datetimepicker2" data-toggle="datetimepicker">
                  <div class="input-group-text"><i class="fa fa-calendar"></i></div>
                </div>
              </div>
            </div>
          </div>
          <script type="text/javascript">
            $(function () {
              $('#datetimepicker2').datetimepicker({
                locale: 'es',
                icons: {
                  time: "far fa-clock",
                  date: "far fa-calendar-alt",
                  up: "fas fa-arrow-up",
                  down: "fas fa-arrow-down"
                }
              });
            });
          </script>
        </div>

        <hr/>

        <div class="row">
          <div class="col-md-2 text-right">
            <p class="font-weight-bold">Tasación</p>
          </div>
          <div class="col-md-2">
            <div class="form-group">
              <label>Tipo</label>
              {{form.tipoTasacion}}
            </div>
          </div>
          <div class="col-md-2">
            <div class="form-group">
              <label>Finalidad</label>
              {{form.finalidad}}
            </div>
          </div>
          <div class="col-md-2">
            <div class="form-group">
              <label>Visita</label>
              {{form.visita}}
            </div>
          </div>
        </div>

         <hr/>

         <div class="row">
            <div class="col-md-2 text-right">
               <p class="font-weight-bold">Cliente</p>
            </div>
            <div class="col-md-4">
               <div class="form-group">
                  <label>Nombre</label>
                  {{form.cliente}}
               </div>
            </div>
            <div class="col-md-2">
               <div class="form-group">
                  <label>Rut</label>
                  {{form.clienteRut}}
               </div>
            </div>
         </div>

         <div class="row">
            <div class="col-md-2 text-right">
            </div>
            <div class="col-md-4">
               <div class="form-group">
                  <label>Email</label>
                  {{form.clienteEmail}}
               </div>
            </div>
            <div class="col-md-2">
               <div class="form-group">
                  <label>Teléfono</label>
                  {{form.clienteTelefono}}
               </div>
            </div>
         </div>

         <hr/>

        <div class="row">
          <div class="col-md-2 text-right">
            <p class="font-weight-bold">Propietario</p>
          </div>
          <div class="col-4">
            <div class="form-group">
              <label>Nombre</label>
              {{form.propietario}}
            </div>
          </div>
          <div class="col-2">
            <div class="form-group">
              <label>Rut</label>
              {{form.propietarioRut}}
            </div>
          </div>
        </div>

        <div class="row">
          <div class="col-md-2 text-right">
          </div>
          <div class="col-4">
            <div class="form-group">
              <label>Email</label>
              {{form.propietarioEmail}}
            </div>
          </div>
          <div class="col-2">
            <div class="form-group">
              <label>Teléfono</label>
              {{form.propietarioTelefono}}
            </div>
          </div>
        </div>

         <hr/>

         <div class="row">
            <div class="col-md-2 text-right">
               <p class="font-weight-bold">Contacto</p>
            </div>
            <div class="col-md-4">
               <div class="form-group">
                  <label>Nombre</label>
                  {{form.contacto}}
               </div>
            </div>
            <div class="col-md-2">
               <div class="form-group">
                  <label>Rut</label>
                  {{form.contactoRut}}
               </div>
            </div>
         </div>

         <div class="row">
            <div class="col-md-2 text-right">
            </div>
            <div class="col-md-4">
               <div class="form-group">
                  <label>Email</label>
                  {{form.contactoEmail}}
               </div>
            </div>
            <div class="col-md-2">
               <div class="form-group">
                  <label>Teléfono</label>
                  {{form.contactoTelefono}}
               </div>
            </div>
         </div>

         <hr/>

         <div class="row" id="propertyType">
            <div class="col-md-2 text-right">
               <p class="font-weight-bold">Bien</p>
            </div>
            <div class="col-md-2">
               <div class="form-group">
                  <label>Tipo</label>
                  {{form.propertyType}}
               </div>
            </div>
            <div class="col-md-2">
               <div class="form-group">
                  <div class="valign-center">
                    <label><span>Rol</span>
                      <i class="material-icons" style="font-size:1.0em;" data-toggle="tooltip" data-placement="top" title="Rol principal. Si existe más de un rol, es posible ingresarlo más tarde en el formulario de tasación.">help_outline</i></label>
                  </div>
                  {{form.rol}}
               </div>
            </div>
         </div>

      <div class="row">
         <div class="col-md-2 text-right"></div>
         <div class="col-md-2">
            <div class="form-group">
               {{form.addressRegion.label_tag}}
               {{form.addressRegion}}
            </div>
         </div>
         <div class="col-md-2">
            <div class="form-group">
               {{form.addressCommune.label_tag}}
               {{form.addressCommune}}
            </div>
         </div>
      </div>

      <div class="row">
         <div class="col-md-2 text-right"></div>
         <div class="col-md-4">
            <div class="form-group">
               {{form.addressStreet.label_tag}}
               {{form.addressStreet}}
            </div>
         </div>

         <div class="col-md-1">
            <div class="form-group">
               {{form.addressNumber.label_tag}}
               {{form.addressNumber}}
            </div>
         </div>

         <div class="col-md-1" id="div_addressNumber2">
            <div class="form-group">
               {{form.addressNumber2.label_tag}}
               {{form.addressNumber2}}
            </div>
         </div>
      </div>

      <hr/>

         <div class="row">
            <div class="col-md-2 text-right">
               <p class="font-weight-bold"></p>
            </div>
            <div class="col-md-6">
               <div class="form-group">
                  {{form.comments.label_tag}}
                  {{form.comments}}
               </div>
            </div>
         </div>

      <!--
      <div class="form-group row">
         <div class="col-md-2">
            {{form.appraisalPrice.label_tag}}
            <div class="input-group">
               {{form.appraisalPrice}}
               <div class="input-group-append">
                  <div class="input-group-text">UF</div>
               </div>
               <div class="invalid-feedback">
                  Ingresar precio
               </div>
            </div>
         </div>
      </div>
      -->
      
      <div class="form-group row mt-4">
         <div class="col-md-2">
         </div>
         <div class="col-md-6">
            <button class="btn btn-dark btn-block align-bottom ld-ext-right" id="btn_create">
              Crear
              <div class="ld ld-ring ld-spin"></div>
            </button>
         </div>
      </div>

   </form>
</div>

<!--
<script>
 $("#id_addressRegion").change(function () {
    var url = $("#form").attr("data-commune-url");
    var regionId = $(this).val();
    $.ajax({
      url: url,
      data: {
       'region': regionId
    },
    success: function (data) {
        $("#id_addressCommune").html($.trim(data));
     }
  });
 });
</script>
-->

<script>

  function showApartmentNumber() {
    var type = $("#propertyType option:selected");
    if (type.val() == 2) {
      $("#div_addressNumber2").find('label').html('Dpto.');
    } else {
      $("#div_addressNumber2").find('label').html('Unidad');
    }
  }

  $('#propertyType').on('change', function() {
    showApartmentNumber();
  });

  $(document).ready(function() {
    showApartmentNumber();
  });

  function valid_rut(rut) {
    function dv(T) {
      var M=0,S=1;
      for (;T;T=Math.floor(T/10)) {
        S=(S+T%10*(9-M++%6))%11;
      }
      return S?S-1:'k';
    };
    if (rut.length < 2) return false
    rut = rut.split('.').join("");
    rut = rut.split('-').join("");
    var digv = rut.charAt(rut.length-1);
    n = rut.substring(0,rut.length-1)
    return (dv(n) == digv);
    rut = parseInt(rut);
    if (isNaN(rut)) {
      return false
    }
    return true
  }
  
  jQuery.validator.addMethod("rut",
    function(value, element) {
      return this.optional(element) || valid_rut(value);
    },
    "El rut no es válido"
  );

  a = {
    rules: {
      "addressStreet": "required",
      "addressNumber": "required",
      "addressCommune": "required",
      "addressRegion": "required",
      "cliente": "required",
      "clienteRut": "rut",
      "contacto": "required",
      "solicitanteCodigo": "required",
      "appraisalTimeRequest": "required",
      "appraisalTimeDue": "required",
      "tipoTasacion": "required",
      "finalidad": "required",
      "visita": "required",
      "propertyType":"required"
    },
    groups: {
      "appraisalTimeRequest": "date"
    },
    messages: {
      "addressStreet": "Campo requerido",
      "addressNumber": "Requerido",
      "addressCommune": "Campo requerido",
      "addressRegion": "Campo requerido",
      "cliente": "Campo requerido",
      "contacto": "Campo requerido",
      "solicitanteCodigo": "Campo requerido",
      "appraisalTimeRequest": "Campo requerido",
      "appraisalTimeDue": "Campo requerido",
      "tipoTasacion": "Campo requerido",
      "finalidad": "Campo requerido",
      "visita": "Campo requerido",
      "propertyType": "Campo requerido",
      "rol": {
        maxlength: "Máximo 20 caracteres"
      },
      "clienteEmail": {
        email: "Email debe tener formato nombre@dominio.com"
      },
      "contactoEmail": {
        email: "Email debe tener formato nombre@dominio.com"
      },
      "solicitanteEjecutivoEmail": {
        email: "Email debe tener formato nombre@dominio.com"
      },
    },
    errorPlacement: function(error, element) {
      if (element.attr("id") == "id_appraisalTimeRequest") {
        error.insertAfter("#datetimepicker1");
      } else if (element.attr("id") == "id_appraisalTimeDue") {
        error.insertAfter("#datetimepicker2");
      } else {
        error.insertAfter(element);
      }
    }
  }

  $("#form").validate(a);

  $('#petitioner').on('change', function() {
    var object = $("#petitioner option:selected");
    if (object.val() == 0 ) {
      $('#other').removeAttr('hidden');
      $('#other').show();
      $('#other').attr('required','required');
      $('#id_solicitanteCodigo').removeAttr('data-validation','required');
      $('#code').removeAttr('class', 'form-group has-error');
      $('.help-block').hide();
      $('#id_solicitanteCodigo').removeAttr('style');
      $('#code').attr('class', 'form-group');
   } else {
      $('#other').hide();
      $('#other').removeAttr('required');
      $('#other').val('');
      $('#id_solicitanteCodigo').attr('data-validation','required');
   }
  });

  $(document).ready(function() {

    $('#id_import_alert').hide()

    var formatFields = function() {
      $('#id_addressStreet').val(function() {
        return toTitleCase($(this).val())
      })
      $('#id_contacto').val(function() {
        return toTitleCase($(this).val())
      })
      $('#id_cliente').val(function() {
        return toTitleCase($(this).val())
      })
      $('#id_solicitanteEjecutivo').val(function() {
        return toTitleCase($(this).val())
      })
      $('#id_solicitanteEjecutivoEmail').val(function() {
        return $(this).val().toLowerCase()
      })
      $('#id_solicitanteSucursal').val(function() {
        return toTitleCase($(this).val())
      })
      $('#id_clienteEmail').val(function() {
        return $(this).val().toLowerCase()
      })
      $('#id_contactoEmail').val(function() {
        return $(this).val().toLowerCase()
      })
    }

    var populateFromFile = function () {
      var form = document.getElementById('form');
      var formData = new FormData(form);
      var url = $("#form").attr("data-populate-from-file-url");
      btn = $(this)
      btn.addClass('running')
      btn.prop('disabled', true);
      $.ajax({
          url: url,
          type: 'post',
          data: formData,
          processData: false,
          contentType: false,
          dataType: 'json',
          error: function () {
            alert("Error al procesar archivo.");
            btn.removeClass('running')
            btn.prop('disabled', false);
            return false;
          },
          success: function (data) {
            $('#id_solicitanteCodigo').val('')
            $('#id_addressNumber').val('')
            $('#id_addressNumber2').val('')
            for (var field in data) {
              $('#id_'+field).val(data[field]);
            }
            if (data.solicitante == 3) {
              // ITAU: warn about things we don't do
              $('#id_import_alert').show()
              $('#id_import_alert').html('Observaciones al importar de Itaú: banco no provee código.\
                Se han ignorado campos. De antecedentes del cliente: N° Cuenta, Personería, Detalle de cuenta.\
                Del bien: Estado, Valor estimado, Otros datos, Antecedentes. \
                Tipo, finalidad y visita no han sido rellenados.')
            } else if (data.solicitante == 2) {
              // Santander
              $('#id_import_alert').show()
              $('#id_import_alert').html('Observaciones al importar de Santander. Se han ignorado los campos: seguimiento, proveedor, estado, coordinar antes de (fecha), visitar propiedad antes de (fecha), localidad, rubro, grupo, nombre formalizador, email formalizador y centro de costo.')
            } else if (data.solicitante == 5) {
              // Chile
              $('#id_import_alert').show()
              $('#id_import_alert').html('Observaciones al importar de Banco de Chile. Se han ignorado los campos: dirección de contacto, CUI ejecutivo solicitante.')
            } else {
              $('#id_import_alert').hide()
            }
            if (data.error) {
              $('#id_import_alert').show()
              $('#id_import_alert').html(data['error'])
            } else {
              formatFields();
              showApartmentNumber();
              $("#form").valid();
            }
            btn.removeClass('running')
            btn.prop('disabled', false);
          }
      });
      return false;
    }

    $("#populate").on("click", function (e) {
      e.preventDefault();
      populateFromFile();
    });

    $("#btn_create").on("click", function (e) {
      if ($("#form").valid()) {
        $(this).addClass('running');
        setTimeout(function () { disableButton(); }, 0);
        //$(this).prop('disabled', true);
      };
    });
    function disableButton() {
      $("#btn_create").prop('disabled', true);
    }
  })

  function toTitleCase(str) {
    return str.replace(
      /\w\S*/g,
      function(txt) {
        return txt.charAt(0).toUpperCase() + txt.substr(1).toLowerCase();
      }
    );
  }

  $("#id_solicitanteEjecutivo").focusout(function() {
    $(this).val(toTitleCase($(this).val()));
  })


  $(function () {
    $('[data-toggle="tooltip"]').tooltip()
  })

</script>

{% endblock %}
